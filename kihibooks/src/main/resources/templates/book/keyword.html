<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/layout.html}">

<head>
  <meta charset="UTF-8">
  <title>í‚¤ì›Œë“œ ê²€ìƒ‰</title>
  <style>

    .keyword-table {
      width: 100%;
      border-top: 1px solid #ccc;
      border-bottom: 1px solid #ccc;
      border-collapse: collapse;
      font-size: 14px;
      table-layout: fixed;
    }

    .keyword-table th {
      width: 120px;
      text-align: left;
      padding: 20px;
      background: #f9f9f9;
      border-right: 1px solid #ddd;
      font-weight: bold;
    }

    .keyword-table td {
      padding: 10px;
    }

    .keyword-scroll-wrapper {
      display: flex;
      align-items: center;
    }

    .keyword-scroll {
      display: flex;
      overflow-x: auto;
      flex: 1;
      gap: 8px;
      padding: 4px 0;
      scrollbar-width: none;
    }

    .keyword-scroll::-webkit-scrollbar {
      display: none;
    }

    .keyword-tag {
      background-color: #f5f5f5;
      border-radius: 16px;
      padding: 6px 12px;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
    }

    .keyword-tag.selected {
      background-color: #ff7f50;
      color: #fff;
      font-weight: bold;
    }

    .arrow-btn {
      width: 28px;
      height: 28px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
    }

    .arrow-btn img {
      width: 14px;
      height: 14px;
    }

    .reset-btn {
      margin-top: 16px;
      font-size: 13px;
      color: #ff7f50;
      background: none;
      border: none;
      cursor: pointer;
      display: none;
    }

    .reset-btn.visible {
      display: inline-block;
    }

    .selected-keyword-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .selected-keyword {
      background-color: #ffe3da;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .selected-keyword .remove-btn {
      background: none;
      border: none;
      color: #888;
      font-size: 14px;
      cursor: pointer;
    }

    .no-result-box {
      text-align: center;
      margin: 80px 0;
    }

    .no-result-img {
      width: 300px;
      opacity: 0.3;
    }

    .no-result-msg {
      margin-top: 20px;
      font-size: 20px;
      color: #999;
    }
    .page-btn {
      padding: 6px 12px;
      margin: 0 4px;
      border: 1px solid #ccc;
      background-color: #fff;
      cursor: pointer;
    }
    .page-btn.active {
      background-color: #ff7f50;
      color: #fff;
      font-weight: bold;
    }


  </style>
</head>
<body>
  <div class="container" layout:fragment="content">

    <h3>ì›¹ì†Œì„¤ í‚¤ì›Œë“œ ê²€ìƒ‰</h3>

    <!-- í‚¤ì›Œë“œ í…Œì´ë¸” ì˜ì—­ -->
    <table class="keyword-table">
      <tbody>
        <tr th:each="category, stat : ${keywordCategories}">
          <th th:text="${category.kc_name}">ì¹´í…Œê³ ë¦¬</th>
          <td>
            <div class="keyword-scroll-wrapper">
              <button class="arrow-btn left" th:attr="data-target='kw-scroll-' + ${stat.index}" onclick="scrollKeywordRow(this, -1)">
                <img src="/resources/static/img/back.png" alt="ì´ì „">
              </button>
              <div class="keyword-scroll" th:attr="id='kw-scroll-' + ${stat.index}">
                <span th:each="keyword : ${category.keywordList}" th:text="${keyword.kw_name}"
                  th:data-id="${keyword.kw_code}" th:data-name="${keyword.kw_name}" class="keyword-tag"
                  th:classappend="${selectedKeywordIds != null and selectedKeywordIds.contains(keyword.kw_code)} ? 'selected' : ''">
                </span>
              </div>
              <button class="arrow-btn right" th:attr="data-target='kw-scroll-' + ${stat.index}" onclick="scrollKeywordRow(this, 1)">
                <img src="/resources/static/img/next.png" alt="ë‹¤ìŒ">
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Ajax ê°±ì‹  ëŒ€ìƒ: ì´ ì˜ì—­ë§Œ fragmentë¡œ êµì²´ë¨ -->
    <div id="bookResultContainer" th:fragment="bookResultFragment">
      <div id="selectedKeywordsContainer" style="margin-top: 30px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div id="selectedKeywords" class="selected-keyword-list">
            <span th:each="kw:${selectedKeywords}" th:text="${kw.kw_name}" th:attr="data-id=${kw.kw_code}" class="selected-keyword">
            </span>
          </div>
          <button id="resetBtn" class="reset-btn" onclick="resetKeywords()">ì „ì²´í•´ì œ</button>
        </div>
      </div>

      <!-- ì¼€ì´ìŠ¤ 1: ì•„ë¬´ í‚¤ì›Œë“œë„ ì„ íƒ ì•ˆ í•¨ -->
      <div th:if="${selectedKeywordIds == null or #lists.isEmpty(selectedKeywordIds)}" class="no-result-box">
        <img src="/resources/static/img/emptykeyword.png" class="no-result-img">
        <div class="no-result-msg">í‚¤ì›Œë“œë¥¼ ì„ íƒí•´ ì‘í’ˆì„ ê²€ìƒ‰í•´ë³´ì„¸ìš”</div>
      </div>

      <!-- ì¼€ì´ìŠ¤ 2: í‚¤ì›Œë“œëŠ” ìˆìœ¼ë‚˜ ë„ì„œ ì—†ìŒ -->
      <div th:if="${selectedKeywordIds != null and not #lists.isEmpty(selectedKeywordIds) and #lists.isEmpty(bookList)}" class="no-result-box">
        <div class="no-result-msg">ì„ íƒí•œ í‚¤ì›Œë“œì— í•´ë‹¹í•˜ëŠ” ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>
        <div class="no-result-msg">ì›í•˜ëŠ” í‚¤ì›Œë“œë¥¼ ë‹¤ì‹œ ê²€ìƒ‰í•´ë³´ì„¸ìš”.</div>
      </div>

      <!-- ì¼€ì´ìŠ¤ 3: ë„ì„œ ê²°ê³¼ ìˆìŒ -->
      <div th:if="${selectedKeywordIds != null and not #lists.isEmpty(selectedKeywordIds) and not #lists.isEmpty(bookList)}">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 40px;">
          <div th:text="${pageInfo.totalCount} + 'ê°œì˜ ì‘í’ˆ'"></div>
          <select onchange="changeSort(this.value)">
            <option value="recent" th:selected="${sort == 'recent'}">ìµœì‹ ìˆœ</option>
            <option value="popular" th:selected="${sort == 'popular'}">ì¸ê¸°ìˆœ</option>
            <option value="rating" th:selected="${sort == 'rating'}">í‰ì ìˆœ</option>
            <option value="review" th:selected="${sort == 'review'}">ë¦¬ë·°ë§ì€ ìˆœ</option>
          </select>
        </div>

        <!-- ë„ì„œ ë¦¬ìŠ¤íŠ¸ -->
        <div th:each="book : ${bookList}" style="display: flex; padding: 20px 0; border-bottom: 1px solid #eee; gap: 16px;">
          <div style="width: 100px; height: 140px; flex-shrink: 0; position: relative;">
            <img th:src="@{'/resources/static/img/default_thumb.png'}" alt="ì¸ë„¤ì¼" style="width: 100%; height: 100%; object-fit: cover; border-radius: 4px;">
            <div th:if="${book.bo_adult == 1}" style="position: absolute; top: 4px; right: 4px; background: red; color: white; font-size: 11px; padding: 2px 6px; border-radius: 10px;">19</div>
          </div>
          <div style="flex: 1;">
            <div style="font-size: 16px; font-weight: bold;" th:text="${book.bo_title}">ì œëª©</div>
            <div style="font-size: 13px; color: #666;" th:text="${book.bo_author} + ' Â· ì´ ' + ${book.bo_total_episode} + 'í™”'">ì‘ê°€ì •ë³´</div>
            <div style="font-size: 13px; color: #d00; margin: 4px 0;">
              â˜…<span th:text="${book.bo_total_rating != null and book.bo_review_count > 0 ? #numbers.formatDecimal((book.bo_total_rating / book.bo_review_count) / 2.0, 1, 1) : '0.0'}">0.0</span>
              <span style="color: #999;">(<span th:text="${book.bo_review_count}">ë¦¬ë·° ìˆ˜</span>)</span>
            </div>
            <div style="font-size: 13px; color: #333; line-height: 1.4; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" th:text="${book.bo_description}">
              ì‘í’ˆ ì„¤ëª…...
            </div>
            <div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 6px;">
              <span th:each="kw : ${book.keywordList}" th:text="'#' + ${kw.kw_name}"
                th:classappend="${selectedKeywordIds != null and selectedKeywordIds.contains(kw.kw_code)} ? 'selected-keyword' : 'keyword-tag'"
                style="background-color: #f0f0f0; border-radius: 14px; font-size: 12px; padding: 4px 8px; color: #555;"></span>
            </div>
          </div>
        </div>

        <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
        <div class="pagination" th:if="${pageInfo.totalPages > 1}" id="paginationContainer">
          <a th:if="${pageInfo.currentPage > 1}"
             th:href="@{/book/keyword(sort=${sort}, page=${pageInfo.currentPage - 1}, keywordIds=${selectedKeywordIds})}"
             class="page-btn">&laquo;</a>
          <span th:each="i : ${#numbers.sequence(pageInfo.startPage, pageInfo.endPage)}">
            <a th:href="@{/book/keyword(sort=${sort}, page=${i}, keywordIds=${selectedKeywordIds})}"
               th:class="${pageInfo.currentPage == i} ? 'page-btn active' : 'page-btn'"
               th:text="${i}">1</a>
          </span>
          <a th:if="${pageInfo.currentPage < pageInfo.totalPages}"
             th:href="@{/book/keyword(sort=${sort}, page=${pageInfo.currentPage + 1}, keywordIds=${selectedKeywordIds})}"
             class="page-btn">&raquo;</a>
        </div>
      </div>
    </div>
  </div>
  <div layout:fragment="script">
    <script>
      // ê³µí†µ ì´ˆê¸°í™” í•¨ìˆ˜
      function initKeywordPage() {
        document.querySelectorAll(".keyword-scroll").forEach(div => {
          updateArrows(div, div.id);
        });

        const urlParams = new URLSearchParams(window.location.search);
        const keywordIds = urlParams.getAll("keywordIds");
        renderSelectedKeywords(keywordIds);
      }

      // DOMContentLoaded ì‹œì ì—ë„ ì´ˆê¸°í™”
      window.addEventListener("DOMContentLoaded", initKeywordPage);

      // í‚¤ì›Œë“œ í´ë¦­ í† ê¸€
      function toggleKeyword(el) {
        const id = el.dataset.id;
        const sort = new URLSearchParams(window.location.search).get("sort") || "recent";

        const urlParams = new URLSearchParams(window.location.search);
        let keywordIds = urlParams.getAll("keywordIds");

        // ì¤‘ë³µ ì œê±° ë° í† ê¸€ ë¡œì§
        if (keywordIds.includes(id)) {
          keywordIds = keywordIds.filter(kw => kw !== id);
        } else {
          keywordIds.push(id);
        }
        updateKeywordResult(keywordIds, sort, 1);
      }

      // ì „ì²´ í•´ì œ
      function resetKeywords() {
        const sort = new URLSearchParams(window.location.search).get("sort") || "recent";
        updateKeywordResult([], sort, 1);
        renderSelectedKeywords([]); // í‚¤ì›Œë“œ ì´ˆê¸°í™”
      }

      // Ajax ë¡œë”© í›„ HTML ê°±ì‹ 
      function updateKeywordResult(keywordIds, sort, page) {
        const query = new URLSearchParams();
        keywordIds.forEach(id => query.append("keywordIds", id));
        query.set("sort", sort);
        query.set("page", page);

        $.ajax({
          url: "/book/keyword/updated", // â† í”„ë˜ê·¸ë¨¼íŠ¸ ë¦¬í„´ìš© GET ë§¤í•‘
          method: "GET",
          data: query.toString(),
          success: function (html) {
            console.log("âœ… Ajax ì„±ê³µ", keywordIds);

            // 1. ì‘ë‹µ ì „ì²´ HTMLì—ì„œ #bookResultContainer DOM ìì²´ë¥¼ ì¶”ì¶œí•´ì„œ í†µì§¸ë¡œ êµì²´
            const newContainer = $("<div>").html(html).find("#bookResultContainer");
            $("#bookResultContainer").replaceWith(newContainer);

            console.log("âœ… bookResultContainer ê°±ì‹  ì™„ë£Œ");

            renderSelectedKeywords(keywordIds);

            document.querySelectorAll(".keyword-tag").forEach(tag => {
              const id = tag.dataset.id;
              if (keywordIds.includes(id)) {
                tag.classList.add("selected");
              } else {
                tag.classList.remove("selected");
              }
            });

            // 3. ì£¼ì†Œì°½ ê°±ì‹ 
            history.replaceState(null, "", `/book/keyword?${query.toString()}`);
          },
          error: function (xhr) {
            console.error("âŒ Ajax ì˜¤ë¥˜", xhr.status, xhr.responseText);
          }
        });
      }



      // ì„ íƒ í‚¤ì›Œë“œ í•˜ë‹¨ ë Œë”ë§
      function renderSelectedKeywords(keywordIds) {
        console.log("ğŸ”¥ renderSelectedKeywords ì‹¤í–‰ë¨", keywordIds);

        const container = document.getElementById("selectedKeywords");
        const resetBtn = document.getElementById("resetBtn");
        if (!container) {
          console.warn("ğŸš¨ selectedKeywords ì»¨í…Œì´ë„ˆ ì—†ìŒ");
          return;
        }

        container.innerHTML = "";
        keywordIds.forEach(id => {
          const keywordName = getKeywordNameById(id); // ë¯¸ë¦¬ ë§µí•‘ëœ ì´ë¦„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
          const span = document.createElement("span");
          span.className = "selected-keyword";
          span.dataset.id = id;
          span.textContent = keywordName;

          const removeBtn = document.createElement("button");
          removeBtn.className = "remove-btn";
          removeBtn.dataset.id = id;
          removeBtn.innerHTML = "&times;";
          span.appendChild(removeBtn);
          
          container.appendChild(span);
        });

        document.getElementById("resetBtn").classList.toggle("visible", keywordIds.length > 0);
      }


      // ì´ë²¤íŠ¸ ìœ„ì„: í‚¤ì›Œë“œ í´ë¦­, ì œê±°, ì „ì²´í•´ì œ
      document.addEventListener("click", function (e) {
        if (e.target.classList.contains("keyword-tag")) {
          toggleKeyword(e.target);
        } else if (e.target.classList.contains("remove-btn")) {
          const idToRemove = e.target.dataset.id;
          const selectedKeywordSpans = document.querySelectorAll(".selected-keyword");
          let keywordIds = Array.from(selectedKeywordSpans)
          .map(span => span.dataset.id)
          .filter(id => id !== idToRemove);

          const sort = new URLSearchParams(window.location.search).get("sort") || "recent";
          updateKeywordResult(keywordIds, sort, 1);
        } else if (e.target.id === "resetBtn") {
          resetKeywords();
        }
      });

      // ì •ë ¬ ë³€ê²½
      function changeSort(value) {
        const selectedTags = document.querySelectorAll(".keyword-tag.selected");
        const keywordIds = Array.from(selectedTags).map(tag => tag.dataset.id);
        updateKeywordResult(keywordIds, value, 1);
      }

      // ì¢Œìš° ìŠ¤í¬ë¡¤
      function scrollKeywordRow(btn, direction) {
        const targetId = btn.dataset.target;
        const scrollDiv = document.getElementById(targetId);
        if (!scrollDiv) return;

        const amount = 180 * direction;
        scrollDiv.scrollBy({ left: amount, behavior: 'smooth' });

        setTimeout(() => updateArrows(scrollDiv, targetId), 300);
      }

      function updateArrows(container, id) {
        const leftBtn = document.querySelector(`.arrow-btn.left[data-target="${id}"]`);
        const rightBtn = document.querySelector(`.arrow-btn.right[data-target="${id}"]`);
        if (leftBtn) leftBtn.style.display = container.scrollLeft <= 10 ? 'none' : 'flex';
        if (rightBtn) rightBtn.style.display = (container.scrollLeft + container.offsetWidth >= container.scrollWidth - 10) ? 'none' : 'flex';
      }
      function updatePagination(pageInfo) {
        const paginationContainer = document.getElementById("paginationContainer");
        if (!paginationContainer) return;
        
        let paginationHtml = '';
        
        // ì´ì „ í˜ì´ì§€
        if (pageInfo.currentPage > 1) {
            paginationHtml += `<a href="?page=${pageInfo.currentPage - 1}" class="page-btn">&laquo;</a>`;
        }
        
        // í˜ì´ì§€ ë²ˆí˜¸
        for (let i = pageInfo.startPage; i <= pageInfo.endPage; i++) {
            paginationHtml += `<a href="?page=${i}" class="page-btn ${i === pageInfo.currentPage ? 'active' : ''}">${i}</a>`;
        }
        
        // ë‹¤ìŒ í˜ì´ì§€
        if (pageInfo.currentPage < pageInfo.totalPages) {
            paginationHtml += `<a href="?page=${pageInfo.currentPage + 1}" class="page-btn">&raquo;</a>`;
        }

        paginationContainer.innerHTML = paginationHtml;
    }
    function getKeywordNameById(id) {
      const allTags = document.querySelectorAll(".keyword-tag");
      for (const tag of allTags) {
        if (tag.dataset.id === id) return tag.dataset.name;
      }
      return id;
    }

    </script>
  </div>
</body>
</html>