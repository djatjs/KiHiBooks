<!DOCTYPE html>
<html
        xmlns:th="http://www.thymeleaf.org"
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
        layout:decorate="~{layout/layout.html}">
<head>
    <meta charset="UTF-8">
    <title>KiHiBooks - ë„ì„œ ì •ë³´ ìˆ˜ì •</title>
    <script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/jquery.validate.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/additional-methods.min.js"></script>
    <style>
        /* ê¸°ë³¸ì ì¸ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            font-family: 'Arial', sans-serif;
        }

        /* í˜ì´ì§€ ì œëª© ìŠ¤íƒ€ì¼ */
        .register-work-page h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            border-bottom: 2px solid #ff7f50;
            padding-bottom: 10px;
            font-weight: bold;
        }
        /* ë“±ë¡ í¼ ìŠ¤íƒ€ì¼ */
        .register-work-form {
            background-color: #f8f9fa;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        /* í¼ ê·¸ë£¹ ìŠ¤íƒ€ì¼ */
        .form-group {
            margin-bottom: 20px;
        }
        /* ë¼ë²¨ ìŠ¤íƒ€ì¼ */
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #34495e;
        }
        /* ëŒ€ë¶„ë¥˜ì™€ ì†Œë¶„ë¥˜ë¥¼ ê°€ë¡œ ì •ë ¬ */
        .category-row {
            display: flex;
            gap: 20px; /* ìš”ì†Œ ì‚¬ì´ ì—¬ë°± */
            justify-content: space-between;
            flex-wrap: wrap;
        }
        /* ê° ì…€ë ‰íŠ¸ ê·¸ë£¹ ìŠ¤íƒ€ì¼ */
        .category-group {
            flex: 1;
            min-width: 200px;
        }
        /* ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ */
        .form-group input[type="text"],
        .form-group input[type="file"],
        .form-group input[type="date"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1rem;
        }
        /* ë²„íŠ¼ ê·¸ë£¹ ìŠ¤íƒ€ì¼ */
        .button-group {
            margin-top: 30px;
            text-align: center;
        }
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .button-group button {
            padding: 10px 20px;
            font-size: 1rem;
            border: none;
            border-radius: .25rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            margin: 0 5px;
        }
        .button-group .btn-primary {
            background-color: #ff7f50;
            color: white;
        }
        .button-group .btn-primary:hover {
            background-color: #ff6347;
        }
        .button-group .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        .button-group .btn-secondary:hover {
            background-color: #5a6268;
        }
        /* í‚¤ì›Œë“œ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        .keyword-list {
            margin-top: 12px;
            border: 1px solid #e0e0e0;
            padding: 15px;
            border-radius: 4px;
            background-color: #ffffff;
        }

        .keyword-list h5 {
            color: #34495e;
            margin-top: 0;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px dashed #cccccc; /* ì¹´í…Œê³ ë¦¬ ì œëª© ì•„ë˜ ì ì„  */
            font-size: 1.1rem;
        }

        .keyword-list div {
            margin-bottom: 15px;
        }

        /* í‚¤ì›Œë“œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .keyword-button {
            width: 75px;
            margin: 3px;
            padding: 5px 10px;
            font-size: 0.6rem;
            border-radius: 15px;
            border: 1px solid #ff7f50 !important;
            color: #ff7f50;
            background-color: #ffffff;
            transition: all 0.2s ease-in-out;
        }

        .keyword-button:hover {
            background-color: #ff7f50;
            color: white;
        }
        .form-group input:read-only{
            background-color: #ffffff;
        }
        
    </style>
</head>
<body>
    <main layout:fragment="content">
        <div class="container register-work-page">
            <h2>ğŸ“– ë„ì„œ ì •ë³´ ìˆ˜ì •</h2>
            <p>ìˆ˜ì •í•  ì‘í’ˆ(ë„ì„œ ì‹œë¦¬ì¦ˆ) ì •ë³´ë¥¼ ì…ë ¥í•˜ê³  ë“±ë¡í•˜ì„¸ìš”.</p>

            <!-- ì‘í’ˆ ìˆ˜ì • í¼ -->
            <form th:action="@{/editor/updateBookInfo/{bo_code}(bo_code=${book.bo_code})}" method="post" class="register-work-form">
                <!-- ë‹´ë‹¹ ì¶œíŒì‚¬ ë²ˆí˜¸ -->
                <input type="hidden" name="pu_code" th:value="${user.pu_code}">
                <input type="hidden" name="bo_code" th:value="${book.bo_code}">

                <!-- ì‘í’ˆ ì œëª© -->
                <div class="form-group">
                    <label class="form-label" for="boTitle">ì‘í’ˆ ì œëª©</label>
                    <input type="text" id="bo_title" name="bo_title" class="form-control" th:value="${book.bo_title}" readonly>
                    <label id="bo_title-error" style="color: red; font-size: 12px; display: none;"></label>
                </div>

                <!-- ì €ìëª… -->
                <div class="form-group">
                    <label class="form-label" for="boAuthor">ì €ìëª…</label>
                    <input type="text" id="bo_author" name="bo_author" class="form-control" th:value="${book.bo_author}" readonly>
                    <label id="bo_author-error" style="color: red; font-size: 12px; display: none;"></label>
                </div>

                <!-- ë‹´ë‹¹ ì—ë””í„° -->
                <div class="form-group">
                    <label class="form-label" for="editorSelect">ë‹´ë‹¹ ì—ë””í„°</label>
                    <select id="editorSelect" name="bo_pi_num" class="form-control">
                        <option th:each="editor : ${editors}" th:value="${editor.pi_num}" th:text="${editor.ur_nickname}" th:selected="${editor.pi_num == book.bo_pi_num}"></option>
                    </select>
                </div>

                <!-- ì¥ë¥´ ì„ íƒ (ëŒ€ë¶„ë¥˜ ë° ì†Œë¶„ë¥˜) -->
                <div class="form-group category-row">
                    <div class="category-group">
                        <input type="hidden" id="initScCode" th:value="${book.bo_sc_code}" />
                        <label class="form-label" for="mainCategory">ëŒ€ë¶„ë¥˜ <span style="color: red;">*</span></label>
                        <select id="mainCategory" name="mainCategory" class="form-control" required>
                            <option value="0">-- ëŒ€ë¶„ë¥˜ ì„ íƒ --</option>
                            <option value="1">ë¡œë§¨ìŠ¤</option>
                            <option value="2">ë¡œíŒ</option>
                            <option value="3">íŒíƒ€ì§€</option>
                            <option value="4">ë¬´í˜‘</option>
                        </select>
                    </div>
                    <div class="category-group">
                        <label class="form-label" for="subCategory">ì†Œë¶„ë¥˜ <span style="color: red;">*</span></label>
                        <select id="bo_sc_code" name="bo_sc_code" class="form-control" required>
                            <option value="">-- ì†Œë¶„ë¥˜ ì„ íƒ --</option>
                        </select>
                        <label id="bo_sc_code-error" style="color: red; font-size: 12px; display: none;"></label>
                    </div>
                </div>
                
                <!-- ì‘í’ˆ ì†Œê°œ -->
                <div class="form-group">
                    <label class="form-label" for="bo_description">ì‘í’ˆ ì†Œê°œ <span style="color: red;">*</span></label>
                    <textarea id="bo_description" name="bo_description" class="form-control" th:text="${book.bo_description}" rows="6"></textarea>
                </div>

                <!-- ì—°ì¬ ì£¼ê¸° ì„ íƒ -->
                <div class="form-group">
                    <label class="form-label" for="bo_serial_schedule">ì—°ì¬ ì£¼ê¸° <span style="color: red;">*</span> </label>
                    <select id="bo_serial_schedule" name="bo_serial_schedule" class="form-control">
                        <option value="" th:selected="${book.bo_serial_schedule == ''}">-- ì„ íƒ ì•ˆí•¨ --</option>
                        <option value="ì›”ìš”ì—°ì¬" th:selected="${book.bo_serial_schedule == 'ì›”ìš”ì—°ì¬'}">ì›”ìš”ì—°ì¬</option>
                        <option value="í™”ìš”ì—°ì¬" th:selected="${book.bo_serial_schedule == 'í™”ìš”ì—°ì¬'}">í™”ìš”ì—°ì¬</option>
                        <option value="ìˆ˜ìš”ì—°ì¬" th:selected="${book.bo_serial_schedule == 'ìˆ˜ìš”ì—°ì¬'}">ìˆ˜ìš”ì—°ì¬</option>
                        <option value="ëª©ìš”ì—°ì¬" th:selected="${book.bo_serial_schedule == 'ëª©ìš”ì—°ì¬'}">ëª©ìš”ì—°ì¬</option>
                        <option value="ê¸ˆìš”ì—°ì¬" th:selected="${book.bo_serial_schedule == 'ê¸ˆìš”ì—°ì¬'}">ê¸ˆìš”ì—°ì¬</option>
                        <option value="í† ìš”ì—°ì¬" th:selected="${book.bo_serial_schedule == 'í† ìš”ì—°ì¬'}">í† ìš”ì—°ì¬</option>
                        <option value="ì¼ìš”ì—°ì¬" th:selected="${book.bo_serial_schedule == 'ì¼ìš”ì—°ì¬'}">ì¼ìš”ì—°ì¬</option>
                        <option value="ì£¼3íšŒ" th:selected="${book.bo_serial_schedule == 'ì£¼3íšŒ'}">ì£¼ 3íšŒ</option>
                    </select>
                </div>

                <!-- ì—°ì¬ ì‹œì‘ì¼ -->
                <div class="form-group">
                    <label class="form-label" for="boStartDate">ì—°ì¬ ì‹œì‘ì¼ <span style="color: red;">*</span> </label>
                    <input type="date" id="bo_publish_date" name="bo_publish_date" class="form-control" th:value="${book.bo_publish_date.substring(0, 10)}" />
                </div>

                <!-- ì„±ì¸ì—´ëŒê°€ëŠ¥ ì—¬ë¶€ -->
                <div class="form-group">
                    <label class="form-label">ì„±ì¸ ì „ìš© ì—¬ë¶€ <span style="color: red;">*</span></label>
                    <div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" th:checked="${book.bo_adult == 'Y'}" type="radio" name="bo_adult" id="adultYes" value="Y">
                            <label class="form-check-label" for="adultYes">ì˜ˆ</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" th:checked="${book.bo_adult == 'N'}" type="radio" name="bo_adult" id="adultNo" value="N">
                            <label class="form-check-label" for="adultNo">ì•„ë‹ˆì˜¤</label>
                        </div>
                    </div>
                </div>

                <!-- ê¸°ë‹¤ë¬´(ê¸°ë‹¤ë¦¬ë©´ ë¬´ë£Œ) ì—¬ë¶€ -->
                <div class="form-group">
                    <label class="form-label">ê¸°ë‹¤ë¬´(ê¸°ë‹¤ë¦¬ë©´ ë¬´ë£Œ) ì ìš© ì—¬ë¶€ <span style="color: red;">*</span></label>
                    <div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" th:checked="${book.bo_wait_for_free == 'Y'}" type="radio" name="bo_wait_for_free" id="waitFreeYes" value="Y" required>
                            <label class="form-check-label" for="waitFreeYes">ì˜ˆ</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" th:checked="${book.bo_wait_for_free == 'N'}" type="radio" name="bo_wait_for_free" id="waitFreeNo" value="N" required checked>
                            <label class="form-check-label" for="waitFreeNo">ì•„ë‹ˆì˜¤</label>
                        </div>
                    </div>
                </div>
                <!-- ê¸°ë‹¤ë¬´ ê¸°ê°„ (ì´ˆê¸°ì—” ìˆ¨ê¹€) -->
                <div class="form-group" id="waitFreeDurationGroup" style="display: none;">
                    <label class="form-label" for="bo_wff_date">ê¸°ë‹¤ë¬´ ê¸°ê°„ <span style="color: red;">*</span></label>
                    <input type="number" id="bo_wff_date" name="bo_wff_date" th:value="${book.bo_wff_date}" class="form-control">
                    <small class="form-text text-muted">ex) 1 : 1ì¼</small>
                </div>

                <!-- ë¬´ë£Œ íšŒì°¨ ìˆ˜ -->
                <div class="form-group">
                    <label class="form-label" for="bo_free_episode">ë¬´ë£Œ íšŒì°¨ ìˆ˜ <span style="color: red;">*</span></label>
                    <input type="number" id="bo_free_episode" name="bo_free_episode" class="form-control" th:value="${book.bo_free_episode}" required min="0" value="0"> <!-- ê¸°ë³¸ê°’ 0í™” -->
                    <small class="form-text text-muted">ì²˜ìŒë¶€í„° ë¬´ë£Œë¡œ ì œê³µë  íšŒì°¨ ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</small>
                </div>

                <!-- í‚¤ì›Œë“œ -->
                <div class="form-group">
                    <label class="form-label" for="bo_keywords">í‚¤ì›Œë“œ <span style="color: red;">*</span></label>
                    <div class="keyword-list">
                        <h5>ì„ íƒëœ í‚¤ì›Œë“œ:</h5>
                        <div class="selected-keywords" id="selected-keywords-area">
                            <th:block th:if="${selectedKeywordList != null}">
                                <th:block th:each="category : ${selectedKeywordList}">
                                    <th:block th:each="keyword : ${category.keywordList}">
                                        <button type="button" class="btn keyword-button selected-keyword-btn"
                                                th:data-keyword="${keyword.kw_code}" th:data-name="${keyword.kw_name}"
                                                th:text="${keyword.kw_name}">
                                        </button>
                                        <input type="hidden" name="bo_keywords" th:value="${keyword.kw_code}">
                                    </th:block>
                                </th:block>
                            </th:block>
                            <small id="no-keywords-message" class="form-text text-muted">
                                ì„ íƒëœ í‚¤ì›Œë“œê°€ ì—†ìŠµë‹ˆë‹¤.
                            </small>
                        </div>

                        <!-- ì „ì²´ í‚¤ì›Œë“œ ì¶œë ¥ -->
                        <th:block th:each="category : ${keywordList}">
                            <h5 th:text="${category.kc_name}"></h5>
                            <div>
                                <th:block th:each="keyword : ${category.keywordList}">
                                    <button type="button" class="btn keyword-button"
                                            th:data-keyword="${keyword.kw_code}"
                                            th:data-name="${keyword.kw_name}"
                                            th:text="${keyword.kw_name}">
                                    </button>
                                </th:block>
                            </div>
                        </th:block>
                    </div>
                </div>

                <!-- ë²„íŠ¼ ê·¸ë£¹ -->
                <div class="button-group">
                    <button type="submit" class="btn btn-primary">ë“±ë¡</button>
                    <button type="button" class="btn btn-secondary" onclick="history.back()">ì·¨ì†Œ</button>
                </div>
            </form>
            <!-- ê¸°ë‹¤ë¬´ ë¼ë””ì˜¤ ë²„íŠ¼ -->
            <script>
                document.addEventListener("DOMContentLoaded", function () {
                    const waitFreeYes = document.getElementById("waitFreeYes");
                    const waitFreeNo = document.getElementById("waitFreeNo");
                    const waitFreeDurationGroup = document.getElementById("waitFreeDurationGroup");
                    const boWffDate = document.getElementById("bo_wff_date");

                    function toggleWaitFreeDuration() {
                        if (waitFreeYes.checked) {
                            waitFreeDurationGroup.style.display = "block";
                        } else {
                            waitFreeDurationGroup.style.display = "none";
                            boWffDate.value = "0"; // ê¸°ë³¸ê°’ 1ì¼ë¡œ ì„¤ì •
                        }
                    }
                    // ì´ˆê¸° ìƒíƒœ ì„¤ì •
                    toggleWaitFreeDuration();
                    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
                    waitFreeYes.addEventListener("change", toggleWaitFreeDuration);
                    waitFreeNo.addEventListener("change", toggleWaitFreeDuration);
                });
            </script>
            <!-- ì¥ë¥´ ì„ íƒ -->
            <script>
                $("#mainCategory").on("change", function(){
                    const mainCategoryValue = $(this).val();
                    $.ajax({
                        url: "/book/getSubCategory",
                        type: 'GET',
                        data: {mainCategoryValue},
                        success: function(response){
                            const $subCategorySelect = $('#bo_sc_code');
                            $subCategorySelect.empty();
                            $subCategorySelect.append('<option value="">-- ì†Œë¶„ë¥˜ ì„ íƒ --</option>');

                            response.forEach(function(subCategory) {
                                $subCategorySelect.append(`
                                    <option value="${subCategory.sc_code}">${subCategory.sc_name}</option>
                                `);
                            });
                        }
                    })
                })
            </script>
            <script>
                document.addEventListener("DOMContentLoaded", function () {
                    const initScCode = $("#initScCode").val(); // ì˜ˆ: "35"
                    
                    if (initScCode && initScCode.length > 0) {
                        const mainCategoryCode = initScCode.charAt(0); // ì•ìë¦¬: ì˜ˆ "3"
                        $("#mainCategory").val(mainCategoryCode).trigger("change"); // ëŒ€ë¶„ë¥˜ ì„¤ì • + change ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°

                        // AJAX ì™„ë£Œ í›„ ì†Œë¶„ë¥˜ë„ ì„ íƒë˜ê²Œ ì²˜ë¦¬
                        const checkInterval = setInterval(function () {
                            const $subCategorySelect = $("#bo_sc_code");
                            if ($subCategorySelect.children("option").length > 1) {
                                $subCategorySelect.val(initScCode); // ì†Œë¶„ë¥˜ ì„ íƒ
                                clearInterval(checkInterval); // ì™„ë£Œë˜ë©´ ì¸í„°ë²Œ ì œê±°
                            }
                        }, 100); // 0.1ì´ˆ ê°„ê²©ìœ¼ë¡œ ì²´í¬
                    }
                });
            </script>
            <!-- í‚¤ì›Œë“œ ì„ íƒ -->
            <script>
                function toggleNoKeywordsMessage() {
                    const selectedArea = $("#selected-keywords-area");
                    const noMessage = $("#no-keywords-message");

                    if (selectedArea.find("button").length === 0) {
                        noMessage.show();
                    } else {
                        noMessage.hide();
                    }
                }

                $(document).on("click", ".keyword-button", function () {
                    const keywordCode = $(this).data("keyword");
                    const keywordName = $(this).data("name");

                    const selectedArea = $("#selected-keywords-area");

                    const existing = selectedArea.find(`[data-keyword="${keywordCode}"]`);
                    if (existing.length > 0) {
                        existing.next("input[name='bo_keywords']").remove();
                        existing.remove();
                    } else {
                        const newBtn = `<button type="button" class="btn keyword-button selected-keyword-btn" data-keyword="${keywordCode}" data-name="${keywordName}">${keywordName}</button>
                                        <input type="hidden" name="bo_keywords" value="${keywordCode}">`;
                        selectedArea.append(newBtn);
                    }

                    toggleNoKeywordsMessage();
                });

                $(document).on("click", ".selected-keyword-btn", function () {
                    $(this).next("input[name='bo_keywords']").remove();
                    $(this).remove();

                    toggleNoKeywordsMessage();
                });

                $(document).ready(function () {
                    toggleNoKeywordsMessage();
                });
            </script>
            <!-- ê²€ì¦ -->
            <script>
                $(".register-work-form").validate({
                    rules : {
                        bo_title : {
                            required : true,
                            maxlength : 50,
                        },
                        bo_author : {
                            required : true,
                            maxlength : 20,
                        },
                        bo_sc_code : {
                            required : true,
                        }
                    },
                    messages : {
                        bo_title : {
                            required : "ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.",
                            maxlength : "50ì ì´ë‚´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”."
                        },
                        bo_author: {
                            required: "ì‘ê°€ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.",
                            maxlength: "20ì ì´ë‚´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”."
                        },
                        bo_sc_code : {
                            required : "ì¥ë¥´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."
                        }
                    },
                    errorPlacement: function(error, element) {
                        const name = element.attr("name");
                        const target = $(`#${name}-error`);
                        target.html(error.text()).css("display", "block");
                    },
                    success: function(label, element) {
                        const name = $(element).attr("name");
                        const target = $(`#${name}-error`);
                        target.text("").hide(); // ì—ëŸ¬ ë©”ì‹œì§€ ì§€ìš°ê³  ìˆ¨ê¹€
                    }
                })
            </script>
        </div>
    </main>

    </body>
</html>
