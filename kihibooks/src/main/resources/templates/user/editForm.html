<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">

<head>
	<meta charset="UTF-8">
	<title>íšŒì›ì •ë³´ ë³€ê²½</title>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.12.0/dist/sweetalert2.min.css">
	<style>
		.page-modify{
			width: 100%;
		}
		.table-wrap{
			border-collapse: collapse;
			border-spacing: 0;
			border-bottom: 1px solid #e6e8eb;
			width: 100%;
		}
		tbody{
			display: table-row-group;
			vertical-align: middle;
			unicode-bidi: isolate;
			border-color: inherit;
		}
		.bt{
			border-top: 1px solid #e6e8eb;
		}
		th{
			text-align: right;
			background: #f2f4f5;
			font-weight: 700;
			color: #867c77;
			width: 150px;
			padding: 10px 14px;
			line-height: 28px;
			font-size: 14px;
			vertical-align: top;
		}
		td{
			font-size: 14px;
			text-align: left;
			padding: 10px 14px;
		}
		.deleteBtn{
			appearance: none;
			outline: 0;
			box-sizing: border-box;
			border-radius: 4px;
			font-weight: 700;
			text-align: center;
			cursor: pointer;
			line-height: 1em;
			vertical-align: baseline;
			background-color: #fff;
			border: 1px solid #d9d4d1;
			font-size: 14px;
			padding: 6px 14px;
			color: #867c77;
		}
		.deleteBtn:hover{
			text-decoration: none;
			color: #867c77;
		}
		.input_wrapper input{
			position: relative;
			width: 240px;
			border-radius: 3px;
			box-sizing: border-box;
			border: 1px solid #a0a0a0;
			padding-right: 10px;
			padding: 6px;
			font-size: 14px;
			font-weight: 700;
		}
		.pw_row{
			margin-top: 10px;
		}
		.pw_row input{
			position: relative;
			width: 240px;
			border-radius: 3px;
			box-sizing: border-box;
			border: 1px solid #a0a0a0;
			padding-right: 10px;
			padding: 6px;
			font-size: 14px;
			font-weight: 700;
		}
		.changeNickBtn, .changePwBtn {
			padding: 7px 14px;
			box-sizing: border-box;
			border-radius: 4px;
			font-weight: 700;
			text-align: center;
			display: inline-block;
			cursor: pointer;
			line-height: 1em;
			vertical-align: baseline;
			color: #fff;
			background: #ff7f50;
			border: 1px solid #fd7848;
			font-size: 14px;
		}
		.changeNickBtn:disabled{
			background: #968c89;
			border: 1px solid #968c89;
		}
		.changePwBtn:disabled{
			background: #968c89;
			border: 1px solid #968c89;
		}
		.change_pw_guide{
			padding: 18px 0 3px 0;
			line-height: 1em;
		}
		.guide_title{
			font-weight: 700;
			color: #736863;
		}
		ul{
			padding: 0;
			margin: 0;
			list-style-position: inside;
		}
		li{
			margin: 3px 0;
			padding: 2px 0;
		}
		.guide{
			position: relative;
			padding: 3px 0 5px 10px;
			list-style-type: none;
			font-weight: 500;
			color: #666;
			font-size: 13px;
		}
		input::placeholder{
			color: #a0a0a0;
		}
		.error-message {
			display: none;
			color: #ff7f50;
			font-size: 12px;
			margin-top: 5px;
		}
	</style>
</head>
<body>
	<main layout:fragment="content" class="container d-flex">
		<div class="page-modify">
			<h5 style="font-weight: 600; color: #333;">ë‚´ ì •ë³´ ê´€ë¦¬</h5>
			<div class="edit-info mt-4">
				<input type="hidden" id="urEmail" th:value="${user.ur_email}">
				<form class="nicknameForm" id="nickname-form">
					<table class="table-wrap">
						<tbody>
							<tr class="ur_email bt">
								<th>ì´ë©”ì¼</th>
								<td>
									<span th:text="${user.ur_email}">ì´ë©”ì¼</span>
									<th:block th:if="${#authentication.principal.authority != 'SUPER' and #authentication.principal.authority != 'EDITOR'}">
										<button type="button" class="deleteBtn" id="del-btn" style="float: right;">íšŒì› íƒˆí‡´</button>
									</th:block>
								</td>
							</tr>
							<tr class="ur_nickname bt">
								<th>ë‹‰ë„¤ì„</th>
								<td>
									<div class="nick_edit">
										<div class="input_wrapper">
											<input type="text" name="ur_nickname" id="ur_nickname" placeholder="ë‹‰ë„¤ì„">
											<div id="ur_nickname-error" class="error-message error "></div>
										</div>
										<ul class="checkNick"></ul>
										<div class="change_nick_guide">
											<ul class="guide_wrapper">
												<li class="guide">3ì ì´ìƒ, ì˜ë¬¸/ìˆ«ìë§Œ ì…ë ¥í•´ì£¼ì„¸ìš”.</li>
											</ul>
										</div>
										<div class="edit_button_wrapper">
											<button type="submit" class="changeNickBtn" disabled>ë‹‰ë„¤ì„ ë³€ê²½</button>
										</div>
									</div>
								</td>
							</tr>
						</tbody>
					</table>
				</form>
				
				<form class="passwordForm">
					<table class="table-wrap">
						<tbody>
							<tr class="ur_pw bt">
								<th>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</th>
								<td>
									<div class="pw_row">
										<input type="password" id="current_pw" name="current_pw" title="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸">
										<div id="current_pw-error" class="error-message"></div>
									</div>
									<div class="pw_row">
										<input type="password" id="newPw" name="newPw" title="ë³€ê²½í•  ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸">
										<div id="newPw-error" class="error-message"></div>
									</div>
									<div class="pw_row">
										<input type="password" id="newPw2" name="newPw2" title="ë³€ê²½í•  ë¹„ë°€ë²ˆí˜¸ í™•ì¸" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸">
										<div id="newPw2-error" class="error-message"></div>
									</div>
									<div class="change_pw_guide">
										<p class="guide_title">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹œ ìœ ì˜ì‚¬í•­</p>
										<ul class="guide_wrapper">
											<li class="guide">3ì ì´ìƒ, ì˜ë¬¸/ìˆ«ì/íŠ¹ìˆ˜ë¬¸ì(!@#$)ë§Œ ì…ë ¥í•´ì£¼ì„¸ìš”.</li>
											<li class="guide">ë‹‰ë„¤ì„ê³¼ ë™ì¼í•œ ë¹„ë°€ë²ˆí˜¸ëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</li>
										</ul>
									</div>
									<div class="edit_button_wrapper">
										<button type="submit" class="changePwBtn" disabled>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
									</div>
								</td>
							</tr>
						</tbody>
					</table>
				</form>
				<!-- ë‹‰ë„¤ì„ validate -->
				<script>
					// jQuery Validate ì„¤ì •
					$(".nicknameForm").validate({
						rules : {
							ur_nickname : {
								required : true,
								duplicateNickName : true,
								regex : /^[ã„±-ã…ê°€-í£a-zA-Z0-9]{3,12}$/,
								notEqualToReservedNickname : true
							}
						},
						messages : {
							ur_nickname : {
								required : "Â·ë‹‰ë„¤ì„ì€ í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤.",
								duplicateNickName : "Â·ì´ë¯¸ ì‚¬ìš©ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.",
								regex : "Â·ë‹‰ë„¤ì„ì€ í•œê¸€, ì˜ì–´, ìˆ«ìë§Œ ê°€ëŠ¥í•˜ë©° 3~12ìì…ë‹ˆë‹¤.",
								notEqualToReservedNickname : "Â·ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” ë‹‰ë„¤ì„ì…ë‹ˆë‹¤."
							}
						},
						errorPlacement: function (error, element) {
							const name = element.attr("name");
							$(`#${name}-error`).html(error).show();
						},
						success: function (label, element) {
							const name = $(element).attr("name");
							$(`#${name}-error`).html("").hide();
						}
					});
					
					// ì»¤ìŠ¤í…€ ë©”ì„œë“œ
					$.validator.addMethod("regex", function(value, element, regex){
						var re = new RegExp(regex);
						return this.optional(element) || re.test(value);
					}, "í˜•ì‹ì„ í™•ì¸í•˜ì„¸ìš”.");
					$.validator.addMethod("duplicateNickName", function(value, element){
						return checkNickName(value);
					}, "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.");
					$.validator.addMethod("notEqualToReservedNickname", function(value, element){
						const reservedNicknames = [
							"íƒˆí‡´í•œì‚¬ìš©ì",
							"ìš´ì˜ì",
							"ê´€ë¦¬ì",
							"admin",
							"administrator",
							"testuser",
							"ì”¨ë°œ", "ê°œìƒˆë¼", "ì§€ë„", "ë³‘ì‹ " // ì˜ˆì‹œ ë¹„ì†ì–´ (ì‹¤ì œ ëª©ë¡ì€ ë” ìƒì„¸í•´ì•¼ í•©ë‹ˆë‹¤)
						];
						const lowerCaseValue = value.toLowerCase();
						return this.optional(element) || !reservedNicknames.includes(lowerCaseValue);
					}, "ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.");

					//ë‹‰ë„¤ì„ ì¤‘ë³µ ì²´í¬
					function checkNickName(nickName){
						let res = true;
						$.ajax({
							async : false,
							url: "/check/nickName",
							method : "POST",
							data : nickName,
							contentType: "text/plain",
							success : function(data){
								res = data === true;
							},
							error : function(){
								res = false;
							}
						});
						return res;
					}
					// ë‹‰ë„¤ì„ í•„ë“œì˜ ëª¨ë“  ìœ íš¨ì„± ê²€ì‚¬ ê²°ê³¼ë¥¼ ì¢…í•©í•˜ì—¬ ë²„íŠ¼ ìƒíƒœë¥¼ ê²°ì •í•˜ëŠ” í•¨ìˆ˜
					function checkOverallNicknameValidity() {
						const isFormValid = $(".nicknameForm").valid();
						$(".changeNickBtn").prop("disabled", !isFormValid);
					}
					$("#ur_nickname").on("input", function() {
						checkOverallNicknameValidity();
					});
				</script>
				<!-- ë¹„ë²ˆ validate -->
				<script>
					$(".passwordForm").validate({
						rules : {
							current_pw : {
								required : true,
								checkPw : true
							},
							newPw : {
								required : true,
								regex : /^[a-zA-Z0-9!@#$]{3,12}$/
							},
							newPw2 : {
								equalTo : newPw
							}
						},
						messages : {
							current_pw : {
								required : "Â·í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.",
								checkPw : "Â·ë¹„ë°€ë²ˆí˜¸ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”."
							},
							newPw : {
								required : "Â·ë¹„ë²ˆì€ í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤.",
								regex : "Â·ë¹„ë²ˆì€ ì˜ì–´, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì(!@#$)ë¡œ ì´ë£¨ì–´ì ¸ ìˆìœ¼ë©°, 3~12ìì…ë‹ˆë‹¤."
							},
							newPw2 : {
								equalTo : "Â·ë¹„ë²ˆê³¼ ë¹„ë²ˆ í™•ì¸ì´ ê°™ì§€ ì•ŠìŠµë‹ˆë‹¤."
							}
						},
						errorPlacement: function (error, element) {
							const name = element.attr("name");
							$(`#${name}-error`).html(error).show();
						},
						success: function (label, element) {
							const name = $(element).attr("name");
							$(`#${name}-error`).html("").hide();
						},
						onkeyup: togglePwButton,
						onfocusout: togglePwButton,
						onchange: togglePwButton
					});

					$.validator.addMethod("checkPw", function(value, element){
						return checkPw(value);
					}, "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
					
					//ë¹„ë²ˆ ì¼ì¹˜ ì²´í¬
					function checkPw(pw){
						let res = false;
						$.ajax({
							async: false,
							url: "/edit/checkPw",
							method: "post",
							data: { pw : pw },
							success: function (data) {
								res = data === true;
							},
							error : function(){
								res = false;
							}
						});
						return res;
					}

					function togglePwButton() {
						const isFormValid = $(".passwordForm").valid();
						$(".changePwBtn").prop("disabled", !isFormValid);
					}
				</script>
				<!-- ë‹‰ë„¤ì„ ë³€ê²½ ì²˜ë¦¬ -->
				<script>
					$(".nicknameForm").on("submit", function(event){
						event.preventDefault();
						var nickname = $("#ur_nickname").val();
						if(!confirm(nickname+"ìœ¼ë¡œ ë‹‰ë„¤ì„ì„ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"))return;

    					// Ajax ë‹‰ë„¤ì„ ë³€ê²½ ìš”ì²­
						$.ajax({
							url: "/edit/changeNickname",
							type: "POST",
							data: {nickname: nickname},
							success: function(res) {
								if(res){
									alert("ë‹‰ë„¤ì„ì´ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
									location.reload();
								}else{alert("ë‹‰ë„¤ì„ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");}
							},
							error: function() {
								alert("ë‹‰ë„¤ì„ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
							}
						});
					})
				</script>
				<script>
					$(".passwordForm").on("submit", function(event){
						event.preventDefault();
						var newPw = $("#newPw").val();
						var ur_email = $("#urEmail").val();
						const userVO = {
							ur_email: ur_email,
							ur_pw: newPw
						};
						if(!confirm("ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"))return;
						$.ajax({
							url : "/resetPw",
							method : "post",
							data: JSON.stringify(userVO),
							contentType: "application/json",
							success : function(res){
								if(res){
									alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
									window.location.href ="/logout";
								}
								else{
									alert("ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
								}
							}
						})
					})
				</script>
				<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.12.0/dist/sweetalert2.all.min.js"></script>
				<script>
					$("#del-btn").on("click", function(){
						Swal.fire({
							title: 'ì •ë§ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', // ëª¨ë‹¬ ì œëª©
							text: 'í•œë²ˆ íƒˆí‡´í•˜ë©´ ë˜ëŒë¦´ ìˆ˜ ì—†ì–´ìš”! ğŸ˜¢',
							icon: 'warning',
							showCancelButton: true,
							confirmButtonColor: '#3085d6', // 'í™•ì¸' ë²„íŠ¼ ìƒ‰ê¹” (ì›í•˜ë©´ ë°”ê¿”ë´!)
							cancelButtonColor: '#d33', // 'ì·¨ì†Œ' ë²„íŠ¼ ìƒ‰ê¹” (ì´ê²ƒë„ ì›í•˜ë©´!)
							confirmButtonText: 'ë„¤, íƒˆí‡´í• ë˜ìš”', // 'í™•ì¸' ë²„íŠ¼ì— í‘œì‹œë  í…ìŠ¤íŠ¸
							cancelButtonText: 'ì•„ë‹ˆìš”, ì·¨ì†Œí• ë˜ìš”' // 'ì·¨ì†Œ' ë²„íŠ¼ì— í‘œì‹œë  í…ìŠ¤íŠ¸
						}).then((result) => {
							// ì‚¬ìš©ìê°€ ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ì´ ë¶€ë¶„ì´ ì‹¤í–‰ë¼! (ë¹„ë™ê¸° ì²˜ë¦¬)
							if (result.isConfirmed) {
								// ì‚¬ìš©ìê°€ 'ë„¤, íƒˆí‡´í• ë˜ìš”' (í™•ì¸) ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ!
								var ur_email = $("#urEmail").val();
								$.ajax({
									url : "/user/resign",
									method : "post",
									data : {ur_email : ur_email},
									success : function(res){
										if(res){
											Swal.fire({
												title: 'íƒˆí‡´ ì™„ë£Œ',
												text: 'ë³´ê³ ì‹¶ì„ê±°ì—ìš” ğŸ˜¢',
												// icon: 'warning',
												confirmButtonColor: '#3085d6',
												confirmButtonText: 'ë©”ì¸ìœ¼ë¡œ',
												
											}).then((result) => {
												if (result.isConfirmed) {
													window.location.href ="/logout";
												}
											});
										}
										else{
											Swal.fire({
												title: 'íƒˆí‡´ ì‹ ì²­ ì‹¤íŒ¨', // ëª¨ë‹¬ ì œëª©
												text: 'ê³¼ì •ì¤‘ ì˜¤ë¥˜ê°€ ìƒê²¼ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš” ğŸ˜¢',
												icon: 'warning',
												confirmButtonColor: '#3085d6',
												confirmButtonText: 'í™•ì¸',
											})
										}
									}
								})
							}
						});
					});
				</script>
			</div>
		</div>
	</main>
</body>
</html>