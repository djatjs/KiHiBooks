<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/layout.html}">

<head>
	<meta charset="UTF-8">
	<title>키히포인트 충전 - 키히</title>
	<script src="https://cdn.iamport.kr/v1/iamport.js"></script>
	<style>
		ul {
			margin: 0;
			padding: 0;
			list-style: none;
		}

		.text {
			padding-left: 20px;
			color: #736763;
			font-size: 15px;
		}

		.bold {
			font-weight: bold;
		}

		.menu-item,
		.t {
			color: #666;
			display: block;
		}

		.menu-item:hover {
			text-decoration: none;
			color: #666;
		}

		.icon {
			filter: grayscale(100%) brightness(0%) invert(40%);
		}

		.selectedIcon {
			filter: brightness(0) saturate(100%) invert(61%) sepia(56%) saturate(387%) hue-rotate(328deg) brightness(101%) contrast(101%);
		}

		.mykihi {
			padding: 0 10px;
			margin-left: 80px;
			width: 900px;
			flex-shrink: 0;
			padding-bottom: 100px;
		}

		.point-tab {
			display: flex;
			width: 100%;
			border-bottom: 2px solid #d9d2d1;
			list-style: none;
			margin: 7px 0 24px;
		}

		.checkout-point,
		.history-point {
			margin-right: 10px;
			display: flex;
			position: relative;
			font-size: 15px;
			font-weight: 700;
			line-height: 18px;
		}

		.checkout-point:hover,
		.history-point:hover {
			text-decoration: none;
		}

		.checkout-point::after {
			background: #ff7f50;
			content: '';
			position: absolute;
			bottom: -8px;
			left: 0;
			right: 0;
			width: 87%;
			height: 4px;
		}

		.history-point:hover::after {
			background: #c7c1c0;
		}

		.history-point::after {
			content: '';
			position: absolute;
			bottom: -4px;
			left: 0;
			right: 0;
			width: 84%;
			height: 4px;
			background: transparent;
		}

		.text>h5 {
			white-space: nowrap;
			color: #141414;
			font-weight: 600;
			line-height: 28px;
			margin-bottom: 9px;
		}

		.text>span {
			color: #555;
			font-weight: 500;
			line-height: 19px;
		}

		.banner {
			padding-bottom: 40px;
		}

		.banner-text {
			display: flex;
			justify-content: center;
			align-items: center;
			height: 135px;
			background: #fff9f7;
		}

		ul {
			margin: 0;
			padding: 0;
		}

		.charge-container {
			margin: 0;
			padding: 0;
			padding-bottom: 40px;
		}

		.charge-point-table {
			list-style: none;
			padding-bottom: 10px;
			border-bottom: 1px solid #e6e6e6;
		}

		.line {
			padding-top: 10px;
			border-top: 1px solid #e6e6e6;
		}

		.p {
			display: flex;
			width: 100%;
			height: 42px;
			align-items: center;
			position: relative;
			color: #141414;
			padding: 0 30px;
		}

		.label {
			display: flex;
			align-items: center;
			box-sizing: border-box;
			width: 100%;
			position: relative;
			height: 100%;
		}

		.label-text {
			display: flex;
			align-items: center;
			justify-content: space-between;
			width: 100%;
			height: 100%;
			cursor: pointer;
		}

		.amount {
			display: flex;
			flex-basis: 75px;
			margin-left: 10px;
			font-weight: 700;
			justify-content: flex-start;
			color: #141414;
		}

		.per {
			display: flex;
			justify-content: center;
			align-items: center;
			min-width: 33px;
			background: #f5f5f5;
			border: 1px solid rgba(0, 0, 0, 0.06);
			flex-shrink: 0;
			padding: 0 5px 0 6px;
			border-radius: 100px;
			font-weight: 600;
			color: #ff7f50;
			margin-left: -5px;
		}

		.per-po {
			display: flex;
			color: #141414;
			justify-content: flex-end;
			font-weight: 500;

		}

		.table-head {
			display: flex;
			height: 46px;
			margin-bottom: 10px;
			border-top: 1px solid #e6e6e6;
			border-bottom: 1px solid #e6e6e6;
			font-weight: 700;
			color: #787878;
			padding: 0 30px;
		}

		.head-title {
			display: flex;
			align-items: center;
			width: 100%;
			justify-content: space-between;
		}

		.label-text span:nth-child(1) {
			width: 80px;
			/* 충전 금액 */
		}

		.label-text span:nth-child(2) {
			width: 40px;
			/* 적립률 */
		}

		.label-text span:nth-child(3) {
			width: 80px;
			/* 포인트 적립 */
		}

		input[type="radio"] {
			accent-color: #ff7f50;

			width: 20px;
			height: 20px;
		}

		.blank {
			display: flex;
			align-items: center;
			width: 29px;
		}

		.payment-container {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		.payment-title {
			display: flex;
			width: 100%;
			font-size: 22px;
			font-weight: 700;
			color: #141414;
			padding-bottom: 8px;
		}

		.payment-wrapper {
			display: flex;
			width: 100%;
			flex-direction: column;
		}

		.payment-normal {
			display: flex;
			align-items: baseline;
			width: 100%;
			overflow-x: hidden;
			border: 2px solid #f77f50;
			flex-direction: column;
		}

		.normal-title {
			position: relative;
			display: flex;
			align-items: center;
			justify-content: space-between;
			width: 100%;
			height: 60px;
			padding: 0 20px;
		}

		.normal-title-text {
			color: #141414;
			font-size: 18px;
			font-weight: 700;
			line-height: 22px;
		}

		.normal-method {
			display: flex;

		}

		.method-ul {
			display: grid;
			grid-template-columns: repeat(auto-fill, 160px);
			grid-gap: 10px 10px;
			justify-content: space-between;
			width: 100%;
			list-style: none;
			padding: 0 20px 20px;
		}

		.pay-method {
			display: flex;
			align-items: center;
			box-sizing: border-box;
			width: 100%;
			cursor: pointer;
		}

		.hidden-checkbox {
			width: 0;
			height: 0;
			border: none;
			box-shadow: none;
		}

		.img-checkbox {
			display: flex;
			align-items: center;
			cursor: pointer;
			width: 22px;
			height: 22px;
		}

		.pay {
			position: relative;
		}

		.img-pay {
			display: flex;
			position: relative;
			align-items: center;
			width: 100%;
			max-width: 148px;
			height: 22px;
			padding-left: 10px;
			color: #141414;
			font-size: 15px;
			font-weight: 500;
			line-height: normal;
		}

		.form-container {
			box-sizing: border-box;
		}

		.consent-wrapper {
			display: flex;
			width: 100%;
			flex-direction: column;
			padding: 30px 0;
		}

		.consent-label {
			box-sizing: border-box;
			display: flex;
			width: 100%;
			align-items: center;
		}

		.consent-content {
			display: flex;
			justify-content: space-between;
			width: 100%;
		}

		.consent-text {
			margin: 0;
			padding: 0;
			color: #141414;
			font-size: 15px;
			font-weight: 500;
			line-height: 22px;
			padding-left: 10px;
			cursor: pointer;
		}

		.form-button {
			display: flex;
			width: 438px;
			height: 52px;
			padding: 17px 10px 16px 10px;
			border-radius: 6px;
			margin: 0 auto 30px;
			justify-content: center;
			font-size: 16px;
			font-style: normal;
			font-weight: 700;
			line-height: 22px;
			color: #fff;
			background-color: #f77f50;
			border: 0;
		}

		.form-ul {
			font-size: 14px;
			font-style: normal;
			font-weight: 400;
			line-height: 17px;
			padding-left: 11px;
			color: #787878;
			list-style: none;
			position: relative;
		}

		.form-ul>li {
			position: relative;
			line-height: 17px;
		}

		.form-ul>li::before {
			content: ' ';
			position: absolute;
			top: 6px;
			left: -12px;
			width: 4px;
			height: 4px;
			background-color: #ccc;
			border-radius: 50%;
		}

		.form-ul li+li {
			margin-top: 9px;
		}
	</style>
</head>

<body>
	<main layout:fragment="content" class="container d-flex" style="min-height: 650px;">
		<div class="left-menu ml-3" style="width: 180px; flex-shrink: 0;">
			<h3 class="mt-4 mb-4" style="font-weight: 600;">마이키히</h3>
			<a th:href="@{/account/mykihi}" class="bold menu-item"><img class="mb-1 icon" src="/resources/static/img/home.png"
					alt="마이 홈" style="height: 15px;"> 마이키히홈</a>
			<hr>
			<div class="book">
				<div class="t bold"><img class="mb-1 icon" src="/resources/static/img/book.png" alt="책" style="height: 15px;"> 책
				</div>
				<div class="mt-2 bold text menu-item">관심 작품</div>
				<a th:href="@{/library/recents}" class="mt-1 bold text menu-item">최근 조회한 작품</a>
			</div>
			<hr>
			<div class="my">
				<div class="t bold"><img class="mb-1 icon" src="/resources/static/img/person.png" alt="개인"
						style="height: 15px;"> 개인</div>
				<a th:href="@{/account/modify}" class="mt-2 bold menu-item text">내 정보 관리</a>
				<div class="mt-1 bold text menu-item">리뷰 관리</div>
			</div>
			<hr>
			<div class="point">
				<div class="t bold">
					<img class="mb-1 icon" src="/resources/static/img/card.png" alt="구매" style="height: 15px;"> 구매/혜택
				</div>
				<a th:href="@{/order/history}" class="mt-2 bold text menu-item">결제 내역</a>
				<a th:href="@{/order/checkout/point}" class="mt-1 bold text menu-item" style="color: #ff7f50;">키히 포인트</a>
			</div>
		</div>
		<div class="mykihi mt-4">
			<div class="content-page">
				<div class="page-point">
					<h5 style="font-weight: 700; color: #222;">키히포인트</h5>
					<div class="point-tab mt-3">
						<a th:href="@{/order/checkout/point}" class="checkout-point mb-2">
							<li class="checkout-point" style="color: #000;">포인트 충전</li>
						</a>
						<a th:href="@{/order/history_point}" class="history-point mb-1">
							<li class="history-point" style="color: #666;">충전 내역</li>
						</a>
					</div>
					<div class="point-banner">
						<div class="banner">
							<a>
								<img src="/resources/static/banners/point_banner.jpg" alt="포인트 배너" style="width: 100%;">
							</a>
						</div>
					</div>
					<div class="charge-container">
						<h5 style="font-weight: 700; color: #222; font-size: 20px;">내 키히포인트
							<span style="color: #ff7f50; font-weight: 700; font-size: 18px;">0원</span>
						</h5>
						<div class="charge-point">
							<ul class="charge-point-table">
								<li class="table-head">
									<span class="blank"></span>
									<span class="head-title">
										<span class="charge-amount">충전 금액</span>
										<span class="percent">적립률</span>
										<span class="per-point">포인트 적립</span>
									</span>
								</li>
								<li class="p">
									<label class="label">
										<input type="radio" class="2000-radio" name="cach-amount" value="2000" title="2000원 선택" readonly
											autocomplete="off">
										<span class="label-text">
											<span class="amount">2,000원</span>
											<span class="per">3%</span>
											<span class="per-po">+60원</span>
										</span>
									</label>
								</li>
								<li class="p">
									<label class="label">
										<input type="radio" class="5000-radio" name="cach-amount" value="5000" title="5000원 선택" readonly
											autocomplete="off">
										<span class="label-text">
											<span class="amount">5,000원</span>
											<span class="per">3%</span>
											<span class="per-po">+150원</span>
										</span>
									</label>
								</li>
								<li class="p">
									<label class="label">
										<input type="radio" class="10000-radio" name="cach-amount" value="10000" title="10000원 선택" readonly
											autocomplete="off">
										<span class="label-text">
											<span class="amount">10,000원</span>
											<span class="per">3%</span>
											<span class="per-po">+300원</span>
										</span>
									</label>
								</li>
								<li class="p">
									<label class="label">
										<input type="radio" class="20000-radio" name="cach-amount" value="20000" title="20000원 선택" readonly
											autocomplete="off">
										<span class="label-text">
											<span class="amount">20,000원</span>
											<span class="per">3%</span>
											<span class="per-po">+600원</span>
										</span>
									</label>
								</li>
								<li class="line"></li>
								<li class="p">
									<label class="label">
										<input type="radio" checked class="30000-radio" name="cach-amount" value="30000" title="30000원 선택"
											readonly autocomplete="off">
										<span class="label-text">
											<span class="amount">30,000원</span>
											<span class="per">4%</span>
											<span class="per-po">+1,200원</span>
										</span>
									</label>
								</li>
								<li class="p">
									<label class="label">
										<input type="radio" class="50000-radio" name="cach-amount" value="50000" title="50000원 선택" readonly
											autocomplete="off">
										<span class="label-text">
											<span class="amount">50,000원</span>
											<span class="per">4%</span>
											<span class="per-po">+2,000원</span>
										</span>
									</label>
								</li>
								<li class="p">
									<label class="label">
										<input type="radio" class="70000-radio" name="cach-amount" value="70000" title="70000원 선택" readonly
											autocomplete="off">
										<span class="label-text">
											<span class="amount">70,000원</span>
											<span class="per">4%</span>
											<span class="per-po">+2,800원</span>
										</span>
									</label>
								</li>
								<li class="line"></li>
								<li class="p">
									<label class="label">
										<input type="radio" class="100000-radio" name="cach-amount" value="100000" title="100000원 선택"
											readonly autocomplete="off">
										<span class="label-text">
											<span class="amount">100,000원</span>
											<span class="per">5%</span>
											<span class="per-po">+5,000원</span>
										</span>
									</label>
								</li>
								<li class="p">
									<label class="label">
										<input type="radio" class="200000-radio" name="cach-amount" value="200000" title="200000원 선택"
											readonly autocomplete="off">
										<span class="label-text">
											<span class="amount">200,000원</span>
											<span class="per">5%</span>
											<span class="per-po">+10,000원</span>
										</span>
									</label>
								</li>
								<li class="p">
									<label class="label">
										<input type="radio" class="300000-radio" name="cach-amount" value="300000" title="300000원 선택"
											readonly autocomplete="off">
										<span class="label-text">
											<span class="amount">300,000원</span>
											<span class="per">5%</span>
											<span class="per-po">+15,000원</span>
										</span>
									</label>
								</li>
								<li class="p">
									<label class="label">
										<input type="radio" class="400000-radio" name="cach-amount" value="400000" title="400000원 선택"
											readonly autocomplete="off">
										<span class="label-text">
											<span class="amount">400,000원</span>
											<span class="per">5%</span>
											<span class="per-po">+20,000원</span>
										</span>
									</label>
								</li>
								<li class="p">
									<label class="label">
										<input type="radio" class="500000-radio" name="cach-amount" value="500000" title="500000원 선택"
											readonly autocomplete="off">
										<span class="label-text">
											<span class="amount">500,000원</span>
											<span class="per">5%</span>
											<span class="per-po">+25,000원</span>
										</span>
									</label>
								</li>
							</ul>
						</div>
					</div>
					<div class="payment-container">
						<h2 class="payment-title">결제 수단</h2>
						<ul class="payment-wrapper">
							<li class="payment-method">
								<div class="payment-normal">
									<div class="normal-title">
										<span class="normal-title-text">일반 결제</span>
									</div>
									<div class="normal-method">
										<ul class="method-ul">
											<li>
												<label class="pay-method kakaopay">
													<input type="checkbox" class="hidden-checkbox" readonly>
													<span class="img-checkbox">
														<img src="/resources/static/check/circle.png" alt="체크박스" style="width: 22px;">
													</span>
													<span class="pay">
														<span aria-label="kakaopay" class="img-pay">
															<img src="/resources/static/logo/kakao_pay.png" alt="카카오페이" style="width: 50px;">
														</span>
													</span>
												</label>
											</li>
											<li>
												<label class="pay-method kakaopay">
													<input type="checkbox" class="hidden-checkbox" readonly>
													<span class="img-checkbox">
														<img src="/resources/static/check/circle.png" alt="체크박스" style="width: 22px;">
													</span>
													<span class="pay">
														<span aria-label="tosspay" class="img-pay">
															<img src="/resources/static/logo/toss_pay.png" alt="토스페이" style="width: 90px;">
														</span>
													</span>
												</label>
											</li>
										</ul>
									</div>
								</div>
							</li>
						</ul>
					</div>
					<div class="form-container">
						<div class="consent-wrapper">
							<label class="consent-label">
								<input type="checkbox" class="hidden-checkbox" readonly>
								<span class="img-checkbox">
									<img src="/resources/static/check/circle.png" alt="체크박스" style="width: 22px;">
								</span>
								<span class="consent-content">
									<p class="consent-text">상품, 가격, 할인 정보, 유의 사항 등을 확인하였으며 구매에 동의합니다. (필수)</p>
								</span>
							</label>
						</div>
						<form>
							<button type="button" class="form-button">키히포인트 충전</button>
						</form>
						<ul class="form-ul">
							<li>키히포인트 충전은 문화비소득공제 신청을 할 수 없습니다.</li>
							<li>미성년자의 경우 결제 시 법정대리인의 동의가 필요하며, 이에 따라 법정대리인의 동의를 받았음을 확인합니다.</li>
						</ul>
					</div>
				</div>
			</div>
		</div>
		<script>
			document.addEventListener('DOMContentLoaded', () => {
				const payMethods = document.querySelectorAll('.pay-method');

				payMethods.forEach(method => {
					method.addEventListener('click', () => {
						const checkbox = method.querySelector('.hidden-checkbox');
						const imgCheckbox = method.querySelector('.img-checkbox img');

						// 모든 체크박스 해제 및 이미지 원복
						payMethods.forEach(otherMethod => {
							const otherCheckbox = otherMethod.querySelector('.hidden-checkbox');
							const otherImgCheckbox = otherMethod.querySelector('.img-checkbox img');
							otherCheckbox.checked = false;
							otherImgCheckbox.src = '/resources/static/check/circle.png';
						});

						// 현재 클릭된 체크박스 체크 및 이미지 변경
						checkbox.checked = true;
						imgCheckbox.src = '/resources/static/check/radio.png';
					});
				});
			});

			document.addEventListener('DOMContentLoaded', () => {
				const consentLabel = document.querySelector('.consent-label');

				consentLabel.addEventListener('click', (e) => {
					// Prevent event from triggering twice if clicking on input or img directly
					e.stopPropagation();

					const checkbox = consentLabel.querySelector('.hidden-checkbox');
					const imgCheckbox = consentLabel.querySelector('.img-checkbox img');

					// Toggle checkbox state
					checkbox.checked = !checkbox.checked;

					// Change image source based on checkbox state
					imgCheckbox.src = checkbox.checked ?
						'/resources/static/check/radio.png' :
						'/resources/static/check/circle.png';
				});
			});

			document.addEventListener('DOMContentLoaded', () => {
				const formButton = document.querySelector('.form-button');

				formButton.addEventListener('click', () => {
					// 결제 수단 확인
					const payMethods = document.querySelectorAll('.pay-method .hidden-checkbox');
					let selectedPayMethod = null;
					payMethods.forEach((checkbox, index) => {
						if (checkbox.checked) {
							const payLabel = checkbox.closest('.pay-method').querySelector('.img-pay').getAttribute('aria-label');
							selectedPayMethod = payLabel;
						}
					});

					if (!selectedPayMethod) {
						alert('결제 수단을 선택해주세요.');
						return;
					}

					// 충전 금액 확인
					const chargeRadios = document.querySelectorAll('.charge-point-table input[name="cach-amount"]');
					let selectedAmount = null;
					chargeRadios.forEach(radio => {
						if (radio.checked) {
							selectedAmount = radio.value;
						}
					});

					if (!selectedAmount) {
						alert('충전 금액을 선택해주세요.');
						return;
					}

					// 구매 동의 확인
					const consentCheckbox = document.querySelector('.consent-label .hidden-checkbox');
					if (!consentCheckbox.checked) {
						alert('구매 동의를 체크해주세요.');
						return;
					}

					// AJAX 요청
					
					const data = {
						method: selectedPayMethod,
						chargeAmount: selectedAmount,
					};
					console.log(data);

					IMP.init("imp33538244");
					$.ajax({
						url: "/payment/pay",
						method: "POST",
						contentType: 'application/json; charset=utf-8',
						data: JSON.stringify(data),
						dataType: 'json',
						success: function (rps) {
							if (rps.success) {
								switch (selectedPayMethod) {
									case 'kakaopay':
										channelKey = "channel-key-3cfa1ce1-28fb-4421-ace6-a9575591474d";
										requestPay(selectedPayMethod, channelKey, rps.orderId, rps.nickname, rps.email);
										break;
									case 'tosspay':
										channelKey = "channel-key-7ccfb396-da1a-4fca-ab3d-736cd2d561a6"
										requestPay(selectedPayMethod, channelKey, rps.orderId, rps.nickname, rps.email);
										break;
									default:
										alert('알 수 없는 결제 수단입니다.');
										break;
								}
							} else {
								alert(rps.message || '결제 요청에 실패했습니다.');
							}
						},
						error: function (xhr, status, error) {
							console.error('결제 실패:', error);
							alert('서버 오류가 발생했습니다.');
						}
					});

					function requestPay(selectedMethod, channelKey, orderId, nickname, email) {
						IMP.request_pay(
							{
								channelKey: channelKey,
								pay_method: selectedMethod,
								merchant_uid: orderId, // 주문 고유 번호
								name: "키히북스(주)",
								amount: selectedAmount,
								buyer_email: email,
								buyer_name: nickname,
							},
							function (response) {
								if (response.success) {
									window.location.href = "/order/checkout/point/finished?merchant_uid=" + orderId;
								}
							}
						);
					}
				});
			});
		</script>
	</main>
</body>

</html>