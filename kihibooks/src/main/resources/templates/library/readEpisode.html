<!DOCTYPE html>
<html
    xmlns:th="http://www.thymeleaf.org"
    xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
    layout:decorate="~{layout/layout.html}">
<head>
    <meta charset="UTF-8">
    <title>ì‘í’ˆ ê°ìƒ</title>
    <style>
        .series-container {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            /* text-align: center; */
        }
        #extracted-text-area {
			-webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            border: 1px dashed #ccc;
            padding: 40px;
            margin: 30px;
            min-height: 700px;
            max-height: 500px;
            overflow-y: auto;
            text-align: left;
            background-color: #ffffff;
            box-sizing: border-box;
        }
		.content-header{
			border-bottom: 2px solid #ff7f50;

		}
        .content-management-page h2 {
            color: #2c3e50;
            /* margin-bottom: 20px; */
            /* padding-bottom: 10px; */
            font-weight: bold;
        }
        .goBack-btn {
            margin-top: 20px;
			font-size: 13px;
			padding: 8px 14px;
			margin: 7px 0 7px 30px;
			color: #fff;
			box-sizing: border-box;
			border-radius: 4px;
			font-weight: 700;
			/* text-align:right; */
            cursor: pointer;
			background: #ff7f50;
			border: 1px solid #ff6730;
		}
        .goBack-btn:hover{
            text-decoration: none;
            color: #fff;
            background-color: #ff6347;
        }
        .reply-container{
            margin: 30px;
            padding: 10px;
            border: 1px dashed #ccc;
            background-color: #ffffff;
        }
        .review-wrapper {
			font-size: 14px;
			overflow-wrap: break-word;
			word-break: break-word;
			line-height: normal;
			margin: 0;
			padding: 0;
			color: #000;
			font-weight: 400;
		}

		.review-wrap {
			padding: 0 30px;
		}

		.rv-wrapper {
			width: 100%;
			margin: 30px 0;
			color: #141414;
		}

		.rv-overview {
			display: flex;
			padding: 8px 0 15px;
			justify-content: space-between;
			align-items: center;
		}

		.rv-rating {
			display: flex;
			align-items: center;
		}

		.rv-rating-text {
			color: #000;
			font-size: 48px;
			font-weight: 600;
			line-height: 57px;
		}

		.rv-rating-img {
			display: grid;
			gap: 4px;
			align-items: center;
			margin-left: 12px;
			margin-bottom: 8px;
		}

		.rating-img-text {
			font-size: 15px;
			font-weight: 700;
			line-height: 17px;
		}

		.rating-star {
			display: flex;
		}

		.rating-star>img {
			margin-right: 4px;
		}

		.rv-rating-cnt {
			display: grid;
			justify-content: end;
			gap: 4px;
			color: #787878;
			text-align: right;
			font-size: 15px;
			line-height: 18px;
		}

		.rating-cnt {
			font-weight: 500;
			cursor: default;
		}

		.rating-bunpo {
			display: flex;
			align-items: center;
			position: relative;
			cursor: pointer;
			user-select: none;
		}

		.bunpo-check {
			display: none;
		}

		.bunpo-text {
			font-weight: 600;
		}

		.none {
			display: none;
		}

		.bunpo-table {
			pointer-events: none;
			opacity: 1;
			position: absolute;
			top: calc(100% + 6px);
			right: 0;
			z-index: 10;
			background: #fff;
			border: 1px solid #ccc;
			border-radius: 4px;
			color: #787878;
			cursor: default;
			font-size: 12px;
			font-weight: 600;
			line-height: 14px;
			transition: opacity 0.3s;
			user-select: text;
			cursor: default;
		}

		.rate-bunpo {
			display: grid;
			grid-template-columns: 9px 1fr;
			align-items: center;
			gap: 6px 10px;
			padding: 12px 16px;
			text-align: center;
		}

		.bunpo {
			width: 72px;
			height: 6px;
			background: #e6e6e6;
			border-radius: 999px;
			overflow: hidden;
		}

		.rate-bunpo-percent {
			height: 100%;
			background: #e54c43;
		}

		.rv-record {
			padding: 0 0 30px;
		}

		.rv-record-star {
			display: grid;
			justify-content: center;
			gap: 20px;
			border-top: 1px solid #e6e6e6;
			margin: 0;
			padding: 40px;
		}

		.record-star-text {
			color: #a5a5a5;
			text-align: center;
			font-size: 15px;
			font-weight: 500;
			line-height: 18px;
			cursor: default;
		}

		.recorded-text-wrap {
			display: flex;
			justify-content: center;
			align-items: center;
			height: 18px;
			display: none;
		}

		.recorded-text {
			font-size: 16px;
			font-weight: 600;
			line-height: 19px;
		}

		.recorded-star {
			color: rgb(229, 76, 67);
		}

		.cancel-rating-btn {
			color: rgb(165, 165, 165);
			font-size: 13px;
			font-weight: 500;
			line-height: 16px;
			margin-left: 10px;
			cursor: pointer;
			appearance: none;
			background: none;
			border: none;
		}

		.recorded-blank {
			width: 1px;
			height: 10px;
			background: rgb(240, 240, 240);
			margin-left: 10px;
		}

		.record-star {
			display: flex;
			flex-direction: row-reverse;
		}

		.record-star>label>input[type='radio'] {
			display: none;
		}

		.record-star label {
			cursor: pointer;
			position: relative;
		}

		.record-star input {
			display: noen;
		}

		.record-star-img {
			height: 48px;
			margin: 0 3px;
		}

		.record-star label:hover~label .record-star-img,
		.record-star label:hover .record-star-img,
		.record-star-img.selected {
			filter: brightness(0) saturate(100%) invert(16%) sepia(98%) saturate(2874%) hue-rotate(-5deg) brightness(92%) contrast(95%);
		}

		.rv-text-area {
			display: grid;
			gap: 10px;
			margin: 0;
			padding: 14px 16px 16px;
			border-radius: 6px;
			border: 1px solid #e6e6e6;
		}

		.rv-textarea {
			opacity: 1;
			height: 72px !important;
			width: 100%;
			min-height: 72px;
			border: none;
			resize: vertical;
			font-size: 15px;
			line-height: 24px;
		}

		.rv-textarea::placeholder {
			color: #b8b8b8;
		}

		.rv-regist-form {
			display: flex;
			justify-content: space-between;
			align-items: center;
			width: 100%;
		}

		.spoiler-label {
			display: flex;
			align-items: center;
			color: #787878;
			cursor: pointer;
			font-size: 14px;
			font-weight: 500;
			line-height: 17px;
		}

		.spoiler-text {
			margin-left: 6px;
			font-size: 14px;
			font-weight: 500;
			line-height: 17px;
		}

		.rv-regist-btn {
			background: #ff7f50;
			cursor: default;
			padding: 9px 18px 8px;
			border-radius: 4px;
			color: white;
			font-size: 14px;
			font-weight: 600;
			line-height: 17px;
			border: 0;
		}

		.rv-note {
			display: grid;
			gap: 10px;
			padding: 12px 0 0;
			cursor: default;
		}

		.rv-note-check {
			display: none;
		}

		.note-check-label {
			display: flex;
			align-items: center;
			width: fit-content;
			color: #787878;
			cursor: pointer;
			font-size: 14px;
			font-weight: 500;
			line-height: 18px;
			user-select: none;
		}

		.check-expand {
			filter: brightness(0) saturate(100%) invert(47%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(95%) contrast(90%);
		}

		.note-content {
			padding: 14px 16px;
			background: #fafafa;
			border-radius: 6px;
			font-size: 14px;
			line-height: 23px;
			text-align: left;
		}

		.rv-arrange-btn {
			display: flex;
			padding: 16px 0;
		}

		.rv-arrange-btn button {
			padding: 10px;
			border-radius: 999px;
			font-size: 16px;
			line-height: 19px;
			appearance: none;
			border: none;
			margin-right: 10px;
		}

		.rv-arrange-btn button[aria-pressed='true'] {
			background: #141414;
			color: #fff;
			font-weight: 700;
		}

		.rv-arrange-btn button[aria-pressed='false'] {
			background: #f5f5f5;
			color: #787878;
			font-weight: 500;
		}

		.rv-ul {
			display: grid;
			list-style-type: none;
			margin: 0;
			padding: 0;
		}

		.rv-li {
			display: grid;
			gap: 10px;
			margin: 0;
			padding: 16px 0;
			line-height: initial;
			border-top: 1px solid #e6e6e6;
		}

		.rv-rate {
			display: flex;
		}

		.rv-rate>img {
			margin-right: 3px;
		}

		.rv-content {
			position: relative;
			outline: none;
		}

		.content-text {
			overflow: hidden;
			text-overflow: ellipsis;
			max-height: calc(24px * 4);
			line-height: 24px;
			white-space: pre-line;
			word-break: break-all;
			overflow-wrap: anywhere;
			cursor: default;
		}

		.rv-content-spoiler {
			display: grid;
			justify-content: center;
			align-items: center;
			gap: 4px;
			padding: 28px 10px;
			background: #fafafa;
			border-radius: 6px;
			cursor: default;
		}

		.content-spoiler {
			display: flex;
			align-items: center;
			margin: auto;
			color: #a5a5a5;
		}

		.spoiler-text {
			color: #787878;
			font-size: 15px;
			font-weight: 500;
			line-height: 24px;
		}

		.spoiler-view-btn {
			display: flex;
			align-items: center;
			margin: auto;
			color: #a5a5a5;
			appearance: none;
			background: none;
			border: none;
		}

		.sv-btn-text {
			font-size: 15px;
			font-weight: 500;
			line-height: 18px;
		}

		.rv-bottom {
			display: flex;
			align-items: center;
			justify-content: space-between;
		}

		.rv-writer-date {
			display: grid;
			gap: 6px;
			color: #a5a5a5;
			line-height: 17px;
		}

		.rv-writer {
			display: grid;
			grid-template-columns: auto auto auto;
			align-items: center;
			gap: 4px;
			width: fit-content;
			font-size: 13px;
			font-weight: 600;
			line-height: 17px;
			cursor: default;
		}

		.rv-right-btn {
			display: flex;
			justify-content: end;
		}

		.rv-delete, .rv-update {
			display: flex;
			justify-content: center;
			align-items: center;
			padding: 8px 7px;
			border-radius: 4px;
			border: 1px solid #e6e6e6;
			background: #fff;
			color: #787878;
			font-size: 13px;
			font-variant-numeric: tabular-nums;
			font-weight: 500;
			line-height: 16px;
			min-width: 65px;
			user-select: none;
			margin-right: 6px;
		}

		.rv-comment {
			display: flex;
			justify-content: center;
			align-items: center;
			padding: 8px 7px;
			border-radius: 4px;
			border: 1px solid #e6e6e6;
			background: #fff;
			color: #787878;
			font-size: 13px;
			font-variant-numeric: tabular-nums;
			font-weight: 500;
			line-height: 16px;
			min-width: 65px;
			user-select: none;
		}

		.rv-like {
			display: flex;
			justify-content: center;
			padding: 8px 7px;
			border-radius: 4px;
			border: 1px solid #e6e6e6;
			background: #fff;
			color: #787878;
			font-variant-numeric: tabular-nums;
			font-weight: 500;
			line-height: 16px;
			margin-left: 6px;
			min-width: 65px;
			user-select: none;
		}

		.rv-more-btn {
			padding: 18px 0 17px 0;
			width: 100%;
			height: 56px;
			display: flex;
			justify-content: center;
			align-items: center;
			position: relative;
			border-radius: 6px;
			border: 1px solid #ccc;
			background: #fff;
			color: #141414;
			font-size: 16px;
			margin-top: 0px;
		}

		.rmb-text {
			display: flex;
			align-items: center;
			font-size: 16px;
			font-weight: 700;
			color: #141414;
		}
		.rv-review {
			background: rgb(250, 250, 250);
			list-style-type: none;
			margin: 0;
			padding: 0;
		}

		.rv-review-li {
			display: grid;
			grid-template-columns: auto 1fr;
			gap: 8px 6px;
			padding: 16px;
			border-top: 1px solid rgb(230, 230, 230);
		}

		.rv-review-content {
			font-size: 15px;
			font-weight: 500;
			line-height: 24px;
			white-space: pre-line;
			overflow-wrap: anywhere;
			margin: 0;
			padding: 0;
		}
		.noStyleBtn{
			color: rgb(165, 165, 165);
			background: none;
			border: none;
			margin-left: auto;
		}
		.rv-review-bottom {
			display: flex;
			align-items: center;
			grid-column: 2 / 3;
			color: rgb(165, 165, 165);
			font-size: 12px;
			font-weight: 500;
			line-height: 14px;
			justify-content: space-between;
		}

		.rv-review-blank {
			background: rgb(240, 240, 240);
			border-radius: 999px;
			width: 1px;
			height: 10px;
			margin: 0px 8px;
		}

		.rv-review-insert {
			padding: 16px;
			border-top: 1px solid rgb(230, 230, 230);
		}

		.review-insert-form {
			position: relative;
			padding: 13px 68px 12px 16px;
			background: rgb(255, 255, 255);
			border: 1px solid rgb(230, 230, 230);
			border-radius: 6px;
			overflow: hidden;
		}

		.review-insert-textarea {
			width: 100%;
			min-height: 28x;
			overflow-y: auto;
			border: none;
			font-size: 14px;
			line-height: 22px;
			resize: vertical;
			white-space: pre-wrap;
			vertical-align: middle;
		}

		.review-insert-textarea::placeholder {
			color: #a5a5a5;
		}

		textarea:focus {
			border: none;
			outline: none;
		}

		.review-submit-btn {
			color: rgb(165, 165, 165);
			cursor: default;
			position: absolute;
			bottom: 0px;
			right: 0px;
			padding: 16px 16px 15px;
			font-size: 14px;
			font-weight: 600;
			appearance: none;
			background: none;
			border: 0;
		}

		.liked {
			color: #ff7f50;

		}
    </style>
</head>
<body>
    <main layout:fragment="content">
        <div class="container content-management-page">
            <div class="content-header d-flex justify-content-between">
				<h2>ğŸ“– ì‘í’ˆ ê°ìƒ</h2>
				<a th:href="@{/library/books/{boCode}(boCode = ${boCode})}" class="goBack-btn">ëª©ë¡ìœ¼ë¡œ</a>
			</div>
            <input type="hidden" th:value="${epCode}" id="epCode">
            <input type="hidden" th:value="${boCode}" id="boCode">
            <div class="series-container">
                <div id="extracted-text-area"></div>
                <!-- ëŒ“ê¸€ -->
                <hr style="margin: 30px;">
                <div class="reply-container">
					<div id="review">
						<div class="review-wrapper">
							<div class="review-wrap">
								<div class="rv-wrapper">
									<h4 class="wrapper-title mb-4 ml-2" th:text="'ëŒ“ê¸€ ìˆ˜ ' + ${commentCnt}">ëŒ“ê¸€</h4>
									<div class="rv-record">
										<div class="rv-text-area">
											<textarea placeholder="ë¦¬ë·°ë¥¼ 10ì ì´ìƒ ì…ë ¥í•´ ì£¼ì„¸ìš”. ê´‘ê³  ë° ìš•ì„¤, íƒ€ì¸ì„ ë¹„ë°©í•˜ëŠ” ë¬¸êµ¬ëŠ” ë¹„ê³µê°œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤." class="rv-textarea"></textarea>
											<form class="rv-regist-form">
												<label class="spoiler-label">
													<input type="checkbox" class="spoiler-check">
													<span class="spoiler-text">ìŠ¤í¬ì¼ëŸ¬ê°€ ìˆìŠµë‹ˆë‹¤.</span>
												</label>
												<button type="submit" class="rv-regist-btn">ëŒ“ê¸€ ë“±ë¡</button>
											</form>
										</div>
										<div class="rv-note">
											<input type="checkbox" id="note_check" class="rv-note-check">
											<label for="note_check" class="note-check-label">
												<span>ëŒ“ê¸€ ì‘ì„± ìœ ì˜ì‚¬í•­</span>
												<img id="note_icon" src="/resources/static/img/expand.png" alt="í¼ì¹˜ê¸°"
													style="width: 20px; margin-left: 3px;" class="check-expand">
											</label>
											<div class="note-content none">
												<strong>ê±´ì „í•œ ëŒ“ê¸€ ì •ì°© ë° ì–‘ì§ˆì˜ ëŒ“ê¸€ì„ ìœ„í•´ ì•„ë˜ í•´ë‹¹í•˜ëŠ” ëŒ“ê¸€ì€ ë¹„ê³µê°œ ì¡°ì¹˜ë  ìˆ˜ ìˆìŒì„
													ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤.</strong>
												<ol style="list-style-type: decimal; list-style-position: outside; margin-left: -25px;">
													<li>íƒ€ì¸ì—ê²Œ ë¶ˆì¾Œê°ì„ ì£¼ëŠ” ìš•ì„¤</li>
													<li>ë¹„ì†ì–´ê°€ íƒ€ì¸ì„ ë¹„ë°©í•˜ëŠ” ë‚´ìš©</li>
													<li>íŠ¹ì • ì¢…êµ, ë¯¼ì¡±, ê³„ì¸µì„ ë¹„ë°©í•˜ëŠ” ë‚´ìš©</li>
													<li>í•´ë‹¹ ì‘í’ˆì˜ ì¤„ê±°ë¦¬ë‚˜ í‚¤íˆ ì„œë¹„ìŠ¤ ì´ìš©ê³¼ ê´€ë ¨ì´ ì—†ëŠ” ë‚´ìš©</li>
													<li>ì˜ë¯¸ë¥¼ ì•Œ ìˆ˜ ì—†ëŠ” ë‚´ìš©</li>
													<li>ê´‘ê³  ë° ë°˜ë³µì ì¸ ê¸€ì„ ê²Œì‹œí•˜ì—¬ ì„œë¹„ìŠ¤ í’ˆì§ˆì„ ë–¨ì–´íŠ¸ë¦¬ëŠ” ë‚´ìš©</li>
													<li>ì €ì‘ê¶Œìƒ ë¬¸ì œì˜ ì†Œì§€ê°€ ìˆëŠ” ë‚´ìš©</li>
													<li>ë‹¤ë¥¸ ëŒ“ê¸€ê¸€ì— ëŒ€í•œ ë°˜ë°•ì´ë‚˜ ë…¼ìŸì„ ìœ ë°œí•˜ëŠ” ë‚´ìš©</li>
												</ol>
												<div style="margin-top: -15px;">* ê²°ë§ì„ ì˜ˆìƒí•  ìˆ˜ ìˆëŠ” ëŒ“ê¸€ì€ì€ ìì œí•˜ì—¬ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.</div>
												<strong>ì´ ì™¸ì—ë„ ê±´ì „í•œ ëŒ“ê¸€ ë¬¸í™” í˜•ì„±ì„ ìœ„í•œ ìš´ì˜ ëª©ì ê³¼ ì·¨ì§€ì— ë§ì§€ ì•ŠëŠ” ë‚´ìš©ì€ ë‹´ë‹¹ìì— ì˜í•´ ë¹„ê³µê°œ ì²˜ë¦¬ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</strong>
											</div>
										</div>
									</div>
									<div class="rv-arrange-btn">
										<button type="button" aria-pressed="true">ìµœì‹ ìˆœ</button>
										<button type="button" aria-pressed="false">ê³µê°ìˆœ</button>
									</div>
									<ul class="rv-ul" id="rv_ul">
										<li class="rv-li" th:each="comment : ${comments}" th:if="${comment.co_ori_num == 0 and comment.co_del == 'N'}">
											
											<div class="rv-content" th:attr="hidden=${comment.co_spoiler == 'Y'}">
												<p class="content-text" th:text="${comment.co_content}"></p>
											</div>
											<div class="rv-content-spoiler" th:attr="hidden=${comment.co_spoiler != 'Y'}">
												<div class="rv-content" hidden>
													<p class="content-text" th:text="${comment.co_content}">
													</p>
												</div>
												<div class="content-spoiler">
													<img src="/resources/static/img/exclamation.png" alt="i ì•„ì´ì½˜" style="height: 23px;"
														class="dark-gray" />
													<span class="spoiler-text">ìŠ¤í¬ì¼ëŸ¬ê°€ ìˆëŠ” ë¦¬ë·°ì…ë‹ˆë‹¤.</span>
												</div>
												<button type="button" class="spoiler-view-btn">
													<span class="sv-btn-text">ë¦¬ë·° ë³´ê¸°</span>
													<img src="/resources/static/img/next.png" alt=">"
														style="height: 12px; margin-bottom: 2px;" class="dark-gray ml-1" />
												</button>
											</div>
											<div class="rv-bottom">
												<div class="rv-writer-date">
													<div class="rv-writer">
														<div class="rv-nick" th:text="${comment.co_user}">
														</div>
														<div class="rv-review-blank"></div>
														<div class="rv-date-text" th:text="${#strings.substring(comment.co_date, 0, 10)}">
														</div>
													</div>
												</div>
												<div class="rv-right-btn">
													<th:block th:if="${#authorization.expression('isAuthenticated()')}">
														<!-- <button type="button" class="rv-delete updateComment"
															th:if="${#authentication.principal.user.ur_num == comment.co_ur_num}"
															th:attr="data-rvNum=${comment.co_num}">
															ìˆ˜ì •
														</button> -->
														<button type="button" class="rv-delete deleteComment"
															th:if="${#authentication.principal.user.ur_num == comment.co_ur_num}"
															th:attr="data-rvNum=${comment.co_num}">
															ì‚­ì œ
														</button>
													</th:block>
													<button type="button" class="rv-comment toggle-replies-btn" th:attr="data-rvnum=${comment.co_num}">
														ëŒ“ê¸€ <span class="ml-1" th:text="${comment.replies.size}"></span>
													</button>
													<button type="button" class="rv-like" th:attr="data-rv-num=${comment.co_num}"
														th:classappend="${likedReviewIds.contains(comment.co_num)}? 'liked' : ''">
														<img src="/resources/static/img/thumb_up.png" alt="ê³µê° ë²„íŠ¼" style="height: 18px;"
															th:classappend="${likedReviewIds.contains(comment.co_num)}? 'orange' : ''">
														<span class="rv-like-cnt" th:text="${likeCountMap[comment.co_num]}"></span>
													</button>
												</div>
											</div>
											<!-- ë‹µê¸€ -->
											<ul class="rv-review" th:id="'replies-' + ${comment.co_num}" style="display: none;">
												<li class="rv-review-li" th:each="reply : ${comment.replies}">
													<img src="/resources/static/img/re_review.png" alt="ã„´" style="height: 15px;" class="dark-gray">
													<p class="rv-review-content" th:text="${reply.co_content}"></p>
													<div class="rv-review-bottom">
														<div class="d-flex justify-content-between">
															<div class="rv-review-user" th:text="${reply.co_user}"></div>
															<div class="rv-review-blank"></div>
															<div class="rv-reivew-date" th:text="${#strings.substring(reply.co_date, 0, 19)}"></div>
														</div>
														<div>
															<th:block th:if="${#authorization.expression('isAuthenticated()')}">
																<!-- <button type="button" class="noStyleBtn updateComment"
																	th:if="${#authentication.principal.user.ur_num == comment.co_ur_num}"
																	th:attr="data-rvNum=${reply.co_num}">
																	ìˆ˜ì •
																</button> -->
																<button type="button" class="noStyleBtn deleteComment"
																	th:if="${#authentication.principal.user.ur_num == comment.co_ur_num}"
																	th:attr="data-rvNum=${reply.co_num}">
																	ì‚­ì œ
																</button>
															</th:block>
														</div>
													</div>
												</li>
												<li class="rv-review-insert">
													<form class="review-insert-form" th:attr="data-rvNum=${comment.co_num}">
														<textarea placeholder="ë‹µê¸€ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”." class="review-insert-textarea"
															style="height: 28px !important;"></textarea>
														<button type="submit" class="review-submit-btn">ë“±ë¡</button>
													</form>
												</li>
											</ul>
										</li>
									</ul>
								</div>
							</div>
						</div>
					</div>
                </div>
            </div>
        </div>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
        <script src="https://unpkg.com/xmldom@0.6.0/dom-parser.js"></script>
        <script src="/resources/static/js/epub.min.js"></script>
		<script>
    		// ìŠ¤í¬ì¼ëŸ¬ ëŒ“ê¸€ -> ë¦¬ë·° ë³´ê¸° í´ë¦­ ì‹œ
			document.body.addEventListener('click', function(event) {
				const clickedButton = event.target.closest('.spoiler-view-btn');
				if (clickedButton) {
					const rvSpoiler = clickedButton.closest('.rv-content-spoiler');
					const rvContent = rvSpoiler ? rvSpoiler.previousElementSibling : null;
					if (rvContent && rvSpoiler) {
						rvContent.removeAttribute('hidden');
						rvSpoiler.setAttribute('hidden', 'true');
					}
				}
			});
		</script>
        <script>
			$(".rv-regist-form").submit(function (e) {
				e.preventDefault();
				const content = $(".rv-textarea").val();
				const spoiler = $(".spoiler-check").is(":checked") ? 'Y' : 'N';
				const ep_code = $("#epCode").val();
				if (content.length === 0) {
					alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
					return;
				}
				const comment = {
					co_ep_code: ep_code,
					co_content: content,
					co_spoiler: spoiler
				};
				$.ajax({
					url: "/comment/insert",
					method: "post",
					data: JSON.stringify(comment),
					contentType: "application/json",
					success: function (data) {
						if (data) {
							alert("ëŒ“ê¸€ ë“±ë¡ ì™„ë£Œ");
							$(".rv-textarea").val('');
							$(".spoiler-check").prop("checked", false);
							location.reload();
						} else {
							alert("ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨");
						}
					}
				});
			});
		</script>
		<script>
			$(".deleteComment").on("click", function(){
				event.preventDefault();
				const co_num = $(this).attr('data-rvNum');
				if(!confirm("ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
				$.ajax({
					url : "/comment/delete",
					method : "post",
					data : {co_num : co_num},
					success : function(res){
						if(res){
							alert("ëŒ“ê¸€ ì‚­ì œ ì™„ë£Œ");
							location.reload();
						}
						else{
							alert("ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨");
						}
					}
				})
			})
		</script>
		<script th:inline="javascript">
			// ëŒ€ëŒ“ê¸€ ë‹¬ê¸°
			$(document.body).on("submit", ".review-insert-form", function(event){
				event.preventDefault();
				const currentForm = $(this);
				const textarea = currentForm.find('.review-insert-textarea');
				const co_content = textarea.val().trim();
				const co_ori_num = currentForm.data('rvnum');
				const co_ep_code = $("#epCode").val();
				if (co_content === '') {
					alert('ë‹µê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
					return;
				}
				console.log(co_ori_num);
				const comment = {
					co_ori_num : co_ori_num,
					co_content : co_content,
					co_ep_code : co_ep_code
				};
				console.log(comment.co_ori_num);
				console.log(comment.co_content);
				console.log(comment.co_ep_code);

				$.ajax({
					url: "/comment/insertRecomment",
					method: "post",
					data: JSON.stringify(comment),
					contentType: "application/json",
					success: function (data) {
						if (data) {
							alert("ëŒ€ëŒ“ê¸€ ë“±ë¡ ì™„ë£Œ");
							location.reload();
						} else {
							alert("ëŒ€ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨");
						}
					},
					error: function(jqXHR, textStatus, errorThrown) {
						console.error("AJAX ì˜¤ë¥˜:", textStatus, errorThrown);
						alert("ëŒ€ëŒ“ê¸€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
					}
				});
			});
		</script>
		<script th:inline="javascript">
            const epCode = $("#epCode").val();
            const boCode = $("#boCode").val();
            const epubFileUrl = "/file/" + boCode + "/epubs/" + epCode + ".epub";

            try {
                const EpubConstructor = typeof ePub !== 'undefined' ? ePub : Epub;
                if (typeof EpubConstructor !== 'function') {
                    throw new Error("ePub.js ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì „ì—­ì— 'ePub' ë˜ëŠ” 'Epub' ê°ì²´ë¥¼ ì •ì˜í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                }
                const book = new EpubConstructor(epubFileUrl);
                console.log("Epub ê°ì²´ ìƒì„±ë¨:", book);
                book.ready.then(function() {
                    console.log("ì±… ë¡œë“œ ë° íŒŒì‹± ì™„ë£Œ!");
                    const spineItems = book.spine.items;
                    console.log("ì±…ì— ìˆëŠ” ì„¹ì…˜/ì±•í„° ìˆ˜:", spineItems.length);
                    const htmlExtractionPromises = spineItems.map(function(item) {
                        console.log(`--- ì„¹ì…˜ ì²˜ë¦¬ ì‹œì‘: ${item.href} ---`);
                        return book.load(item.href)
                            .then(loadedContent => { 
                                let processedContent;

                                // loadedContentê°€ XMLDocument ê°ì²´ì¸ ê²½ìš° (ePub.jsê°€ ì´ë¯¸ DOMìœ¼ë¡œ íŒŒì‹±í•´ ë„˜ê²¨ì¤€ ê²½ìš°)
                                if (loadedContent && typeof loadedContent.documentElement === 'object' && loadedContent.documentElement.nodeName) {
                                    console.log(`DEBUG: Loaded content is XMLDocument object for ${item.href}`);
                                    processedContent = loadedContent; // ì§ì ‘ ì¡°ì‘í•  DOM ê°ì²´
                                } else if (typeof loadedContent === 'string') {
                                    console.log(`DEBUG: Loaded content is string for ${item.href}. Using DOMParser.`);
                                    const parser = new DOMParser();
                                    processedContent = parser.parseFromString(loadedContent, 'application/xhtml+xml');
                                } else {
                                    console.warn(`ì„¹ì…˜ '${item.href}'ì˜ ì½˜í…ì¸  í˜•ì‹ì„ ì•Œ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, loadedContent);
                                    return ""; // ì•Œ ìˆ˜ ì—†ëŠ” ì½˜í…ì¸ ëŠ” ë¹ˆ ë¬¸ìì—´ ë°˜í™˜
                                }

                                // head ë° title íƒœê·¸ ë‚´ìš© ì œê±°
                                const headElement = processedContent.querySelector('head');
                                if (headElement) headElement.remove();
                                const titleElement = processedContent.querySelector('title');
                                if (titleElement) titleElement.remove();

                                // ìˆ˜ì •ëœ DOMì„ HTML ë¬¸ìì—´ë¡œ ì§ë ¬í™”
                                const finalHtml = new XMLSerializer().serializeToString(processedContent);
                                console.log(`DEBUG: Final processed HTML (first 500 chars): ${finalHtml.substring(0, 500)}...`);
                                return finalHtml;
                            })
                            .catch(error => {
                                console.error(`ì„¹ì…˜ '${item.href}' ë¡œë“œ ì¤‘ ì˜¤ë¥˜:`, error);
                                return "";
                            });
                    });

                    Promise.all(htmlExtractionPromises)
                        .then(function(htmls) {
                            let fullHtmlContent = htmls.join("");
                            console.log("--- EPUB ì „ì²´ HTML ì¶”ì¶œ ì™„ë£Œ ---");
                            const extractedTextArea = document.getElementById("extracted-text-area");
                            if (extractedTextArea) {
                                extractedTextArea.innerHTML = fullHtmlContent;
                            }
                        })
                        .catch(function(error) {
                            console.error("HTML ì¶”ì¶œ ê³¼ì • ì¤‘ ì˜¤ë¥˜ (Promise.all catch ë¸”ë¡):", error);
                            const extractedTextArea = document.getElementById("extracted-text-area");
                            if (extractedTextArea) {
                                extractedTextArea.innerText = "HTML ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + error.message;
                            }
                        });

                }).catch(function(error) {
                    console.error("ì±… ë¡œë“œ ì¤€ë¹„ ì¤‘ ì˜¤ë¥˜:", error);
                    const extractedTextArea = document.getElementById("extracted-text-area");
                    if (extractedTextArea) {
                        extractedTextArea.innerText = "EPUB íŒŒì¼ì„ ë¡œë“œí•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message;
                    }
                });

            } catch (e) {
                console.error("EPUB ë·°ì–´ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ë˜ëŠ” ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", e);
                const extractedTextArea = document.getElementById("extracted-text-area");
                if (extractedTextArea) {
                    extractedTextArea.innerText = "EPUB ë·°ì–´ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ë˜ëŠ” ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e.message;
                }
            }
        </script>
        <script>
			// ìœ ì˜ì‚¬í•­ ì•ˆë‚´
            const noteCheckLabel = document.querySelector(".note-check-label");
            const noteContent = document.querySelector(".note-content");
            noteCheckLabel.addEventListener("click", function () {
                if (noteContent.classList.contains("none")) {
                    noteContent.classList.remove("none");
                    noteIcon.src = "/resources/static/img/fold.png";
                    noteIcon.alt = "ì ‘ê¸°";
                } else {
                    noteContent.classList.add("none");
                    noteIcon.src = "/resources/static/img/expand.png";
                    noteIcon.alt = "í¼ì¹˜ê¸°";
                }
            });
        </script>
        <script>
            function loadRvList(sort) {
                const epCode = $("#epCode").val();
                $.ajax({
                    url: "/comment/sort",
                    method: "GET",
                    data: {
                        sort: sort,
                        ep_code: epCode
                    },
                    contentType: 'text/html; charset=utf-8',
                    success: function (html) {
						$("#rv_ul").html(html);
                    },
                    error: function (xhr, status, error) {
                        console.log('ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
                    }
                });
            }
            // ì •ë ¬ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë°”ì¸ë”©
            document.addEventListener("DOMContentLoaded", function () {
                const arrangeButtons = document.querySelectorAll('.rv-arrange-btn button');

                arrangeButtons.forEach(button => {
                    button.addEventListener('click', function () {
                        arrangeButtons.forEach(btn => btn.setAttribute('aria-pressed', 'false'));
                        this.setAttribute('aria-pressed', 'true');

                        // í…ìŠ¤íŠ¸ë¡œ ì •ë ¬ ë°©ì‹ ê²°ì •
                        const text = this.textContent.trim();
                        let sortKey = "recent";
                        if (text.includes("ê³µê°")) sortKey = "likes";
                        else if (text.includes("ë†’ì€")) sortKey = "high";
                        else if (text.includes("ë‚®ì€")) sortKey = "low";

                        // ì •ë ¬ëœ ë¦¬ë·° ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°
                        // al
                        loadRvList(sortKey);
                    });
                });

                $("#rv_ul").on("click", ".rv-comment.toggle-replies-btn", function() {
					// 'this'ëŠ” í´ë¦­ëœ .rv-comment.toggle-replies-btn ìš”ì†Œë¥¼ ê°€ë¦¬í‚´
					const rvNum = $(this).attr('data-rvnum'); // data-rvnum ì†ì„± ê°’ ê°€ì ¸ì˜¤ê¸°
					const replies = $('#replies-' + rvNum); // í•´ë‹¹ ëŒ“ê¸€ì˜ ë‹µê¸€ ul ì°¾ê¸° (IDê°€ ë™ì ìœ¼ë¡œ ìƒì„±ë˜ë‹ˆê¹Œ jQuery ì…€ë ‰í„°ë¡œ ì°¾ìŒ)

					if (replies.length) { // ìš”ì†Œê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
						replies.toggle(); // jQueryì˜ toggle() í•¨ìˆ˜ë¡œ display: none <-> block ì „í™˜
					}
				});
            });
        </script>
		<script th:inline="javascript">
			$(document).on("click", ".rv-like", function () {
				const $btn = $(this);
				const $img = $(this).find("img");
				const co_num = $btn.data("rvNum");

				$.ajax({
					url : "/comment/like",
					method : "post",
					data : {co_num : co_num},
					success : function(data){
						const $countSpan = $btn.find(".rv-like-cnt");
						$countSpan.text(data.likeCount);
						if (!data.liked){
							$btn.addClass("liked");
							$img.addClass("orange");
						}
						else{
							$btn.removeClass("liked");
							$img.removeClass("orange");
						}
					},error : function () {
						alert("ì˜¤ë¥˜ ë°œìƒ");
					}
				})
			});
		</script>
    </main>
</body>
</html>